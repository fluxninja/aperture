apiVersion: consul.hashicorp.com/v1alpha1
kind: ProxyDefaults
metadata:
  name: global
spec:
  config:
    envoy_public_listener_json: |
      {
        "@type": "type.googleapis.com/envoy.config.listener.v3.Listener",
        "name": "public_listener",
        "address": {
            "socket_address": {
                "address": "0.0.0.0",
                "port_value": 15006
            }
        },
        "filter_chains": [
            {
                "filters": [
                    {
                        "name": "envoy.filters.network.http_connection_manager",
                        "typed_config": {
                            "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager",
                            "stat_prefix": "hello_world_service",
                            "access_log": [
                                {
                                    "name": "envoy.access_loggers.open_telemetry",
                                    "typed_config": {
                                        "@type": "type.googleapis.com/envoy.extensions.access_loggers.open_telemetry.v3.OpenTelemetryAccessLogConfig",
                                        "common_config": {
                                            "log_name": "ingress",
                                            "grpc_service": {
                                                "google_grpc": {
                                                    "target_uri": "aperture-agent.aperture-agent.svc.cluster.local:8080",
                                                    "stat_prefix": "aperture_access_log"
                                                }
                                            },
                                            "transport_api_version": "V3"
                                        },
                                        "body": {
                                            "string_value": "%REQ(:METHOD)%"
                                        },
                                        "attributes": {
                                            "values": [
                                                {
                                                    "key": "aperture.source",
                                                    "value": {
                                                        "string_value": "envoy"
                                                    }
                                                },
                                                {
                                                    "key": "aperture.check_response",
                                                    "value": {
                                                        "string_value": "%DYNAMIC_METADATA(envoy.filters.http.ext_authz:aperture.check_response)%"
                                                    }
                                                },
                                                {
                                                    "key": "http.status_code",
                                                    "value": {
                                                        "string_value": "%RESPONSE_CODE%"
                                                    }
                                                },
                                                {
                                                    "key": "authz_duration",
                                                    "value": {
                                                        "string_value": "%DYNAMIC_METADATA(envoy.filters.http.ext_authz:ext_authz_duration)%"
                                                    }
                                                },
                                                {
                                                    "key": "BYTES_RECEIVED",
                                                    "value": {
                                                        "string_value": "%BYTES_RECEIVED%"
                                                    }
                                                },
                                                {
                                                    "key": "BYTES_SENT",
                                                    "value": {
                                                        "string_value": "%BYTES_SENT%"
                                                    }
                                                },
                                                {
                                                    "key": "DURATION",
                                                    "value": {
                                                        "string_value": "%DURATION%"
                                                    }
                                                },
                                                {
                                                    "key": "REQUEST_DURATION",
                                                    "value": {
                                                        "string_value": "%REQUEST_DURATION%"
                                                    }
                                                },
                                                {
                                                    "key": "REQUEST_TX_DURATION",
                                                    "value": {
                                                        "string_value": "%REQUEST_TX_DURATION%"
                                                    }
                                                },
                                                {
                                                    "key": "RESPONSE_DURATION",
                                                    "value": {
                                                        "string_value": "%RESPONSE_DURATION%"
                                                    }
                                                },
                                                {
                                                    "key": "RESPONSE_TX_DURATION",
                                                    "value": {
                                                        "string_value": "%RESPONSE_TX_DURATION%"
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "name": "envoy.access_loggers.open_telemetry",
                                    "typed_config": {
                                        "@type": "type.googleapis.com/envoy.extensions.access_loggers.open_telemetry.v3.OpenTelemetryAccessLogConfig",
                                        "common_config": {
                                            "log_name": "egress",
                                            "grpc_service": {
                                                "google_grpc": {
                                                    "target_uri": "aperture-agent.aperture-agent.svc.cluster.local:8080",
                                                    "stat_prefix": "aperture_access_log"
                                                }
                                            },
                                            "transport_api_version": "V3"
                                        },
                                        "body": {
                                            "string_value": "%REQ(:METHOD)%"
                                        },
                                        "attributes": {
                                            "values": [
                                                {
                                                    "key": "aperture.source",
                                                    "value": {
                                                        "string_value": "envoy"
                                                    }
                                                },
                                                {
                                                    "key": "aperture.check_response",
                                                    "value": {
                                                        "string_value": "%DYNAMIC_METADATA(envoy.filters.http.ext_authz:aperture.check_response)%"
                                                    }
                                                },
                                                {
                                                    "key": "http.status_code",
                                                    "value": {
                                                        "string_value": "%RESPONSE_CODE%"
                                                    }
                                                },
                                                {
                                                    "key": "authz_duration",
                                                    "value": {
                                                        "string_value": "%DYNAMIC_METADATA(envoy.filters.http.ext_authz:ext_authz_duration)%"
                                                    }
                                                },
                                                {
                                                    "key": "BYTES_RECEIVED",
                                                    "value": {
                                                        "string_value": "%BYTES_RECEIVED%"
                                                    }
                                                },
                                                {
                                                    "key": "BYTES_SENT",
                                                    "value": {
                                                        "string_value": "%BYTES_SENT%"
                                                    }
                                                },
                                                {
                                                    "key": "DURATION",
                                                    "value": {
                                                        "string_value": "%DURATION%"
                                                    }
                                                },
                                                {
                                                    "key": "REQUEST_DURATION",
                                                    "value": {
                                                        "string_value": "%REQUEST_DURATION%"
                                                    }
                                                },
                                                {
                                                    "key": "REQUEST_TX_DURATION",
                                                    "value": {
                                                        "string_value": "%REQUEST_TX_DURATION%"
                                                    }
                                                },
                                                {
                                                    "key": "RESPONSE_DURATION",
                                                    "value": {
                                                        "string_value": "%RESPONSE_DURATION%"
                                                    }
                                                },
                                                {
                                                    "key": "RESPONSE_TX_DURATION",
                                                    "value": {
                                                        "string_value": "%RESPONSE_TX_DURATION%"
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            ],
                            "http_filters": [
                                {
                                    "name": "envoy.filters.http.ext_authz",
                                    "typed_config": {
                                        "@type": "type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz",
                                        "grpc_service": {
                                            "google_grpc": {
                                                "target_uri": "aperture-agent.aperture-agent.svc.cluster.local:8080",
                                                "stat_prefix": "ext_authz"
                                            },
                                            "timeout": "10s",
                                            "initial_metadata": [
                                                {
                                                    "key": "control-point",
                                                    "value": "ingress"
                                                }
                                            ]
                                        },
                                        "failure_mode_allow": true,
                                        "transport_api_version": "V3"
                                    }
                                },
                                {
                                    "name": "envoy.filters.http.ext_authz",
                                    "typed_config": {
                                        "@type": "type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz",
                                        "grpc_service": {
                                            "google_grpc": {
                                                "target_uri": "aperture-agent.aperture-agent.svc.cluster.local:8080",
                                                "stat_prefix": "ext_authz"
                                            },
                                            "timeout": "10s",
                                            "initial_metadata": [
                                                {
                                                    "key": "control-point",
                                                    "value": "egress"
                                                }
                                            ]
                                        },
                                        "failure_mode_allow": true,
                                        "transport_api_version": "V3"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        ]
      }
