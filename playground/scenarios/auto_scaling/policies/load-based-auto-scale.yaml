# yaml-language-server: $schema=../../../../blueprints/policies/service-protection/average-latency/gen/definitions.json
# Generated values file for policies/service-protection/average-latency blueprint
# Documentation/Reference for objects and parameters can be found at:
# https://docs.fluxninja.com/reference/policies/bundled-blueprints/policies/service-protection/average-latency

common:
  # Name of the policy.
  # Type: string
  # Required: True
  policy_name: load-based-auto-scale

policy:
  # List of additional circuit components.
  # Type: []aperture.spec.v1.Component
  components:
    - query:
        promql:
          query_string: 'avg(avg_over_time(k8s_pod_cpu_utilization{k8s_deployment_name="service1-demo-app"}[30s]))'
          evaluation_interval: 10s
          out_ports:
            output:
              signal_name: AVERAGE_CPU
    - auto_scale:
        auto_scaler:
          parameters:
            scaler:
              kubernetes_replicas:
                kubernetes_object_selector:
                  namespace: demoapp
                  api_version: apps/v1
                  kind: Deployment
                  name: service1-demo-app
            min_scale: "1"
            max_scale: "10"
            scale_in_cooldown: "40s"
            scale_out_cooldown: "30s"
            scale_out_controllers:
              - controller:
                  gradient:
                    in_ports:
                      signal:
                        signal_name: OBSERVED_LOAD_MULTIPLIER
                      setpoint:
                        constant_signal:
                          value: 1.0
                    parameters:
                      slope: -1.0
            scale_in_controllers:
              - controller:
                  gradient:
                    in_ports:
                      signal:
                        signal_name: AVERAGE_CPU
                      setpoint:
                        constant_signal:
                          value: 0.5
                    parameters:
                      slope: 1.0
  service_protection_core:
    adaptive_load_scheduler:
      load_scheduler:
        # The selectors determine the flows that are protected by this policy.
        # Type: []aperture.spec.v1.Selector
        # Required: True
        selectors:
          - control_point: ingress
            service: service1-demo-app.demoapp.svc.cluster.local
  latency_baseliner:
    # Flux Meter defines the scope of latency measurements.
    # Type: aperture.spec.v1.FluxMeter
    # Required: True
    flux_meter:
      selectors:
        - control_point: ingress
          service: service1-demo-app.demoapp.svc.cluster.local
