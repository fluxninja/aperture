# yaml-language-server: $schema=../../../../blueprints/policies/service-protection/average-latency/gen/definitions.json
# Generated values file for policies/service-protection/average-latency blueprint
# Documentation/Reference for objects and parameters can be found at:
# https://docs.fluxninja.com/reference/blueprints/policies/service-protection/average-latency
policy:
  # Name of the policy.
  # Type: string
  # Required: True
  policy_name: jmx-service-protection
  # Additional resources.
  # Type: aperture.spec.v1.Resources
  resources:
      infra_meters:
        prometheus:
          agent_group: default
          per_agent_group: true
          pipeline:
            receivers:
              - prometheus
          receivers:
            prometheus:
              config:
                scrape_configs:
                  - job_name: "java-demo-app-jmx"
                    scrape_interval: 10s
                    kubernetes_sd_configs:
                      - role: pod
                        namespaces:
                          names:
                            - demoapp
                    relabel_configs:
                      - source_labels:
                          [
                            __meta_kubernetes_pod_annotation_prometheus_io_scrape,
                          ]
                        action: keep
                        regex: true
                      - source_labels: [__address__]
                        action: keep
                        regex: (.*?:8087)
                  - job_name: "java-demo-app-micrometer"
                    scrape_interval: 10s
                    metrics_path: "/actuator/prometheus"
                    kubernetes_sd_configs:
                      - role: pod
                        namespaces:
                          names:
                            - demoapp
                    relabel_configs:
                      - source_labels:
                          [
                            __meta_kubernetes_pod_annotation_prometheus_io_scrape,
                          ]
                        action: keep
                        regex: true
                      - source_labels: [__address__]
                        action: keep
                        regex: (.*?:8099)

  service_protection_core:
    overload_confirmations:
      - query_string: 'avg(java_lang_OperatingSystem_CpuLoad{k8s_pod_name=~"service3-demo-app-.*"})'
        threshold: 0.35
        operator: gt
      - query_string: 'avg(java_lang_Copy_LastGcInfo_duration{k8s_pod_name=~"service3-demo-app-.*"})'
        threshold: 30
        operator: gt
    adaptive_load_scheduler:
      load_scheduler:
        # The selectors determine the flows that are protected by this policy.
        # Type: []aperture.spec.v1.Selector
        # Required: True
        selectors:
          - service: service1-demo-app.demoapp.svc.cluster.local
            control_point: awesomeFeature
      # Linear increment to load multiplier in each execution tick (0.5s) when the system is not in overloaded state.
      # Type: float64
      load_multiplier_linear_increment: 0.0025

  latency_baseliner:
    latency_tolerance_multiplier: 1.1
    # Flux Meter defines the scope of latency measurements.
    # Type: aperture.spec.v1.FluxMeter
    # Required: True
    flux_meter:
      selectors:
        - control_point: awesomeFeature
          service: service3-demo-app.demoapp.svc.cluster.local
