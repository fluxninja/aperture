syntax = "proto3";

package aperture.flowcontrol.v1;

// FlowControlService is used to perform Flow Control operations.
service FlowControlService {
  // Check wraps the given arbitrary resource and matches the given labels
  // against Flow Control Limiters to makes a decision whether to allow/deny
  rpc Check(CheckRequest) returns (CheckResponse) {}
}

// CheckRequest contains fields required to perform Check call.
message CheckRequest {
  string feature = 1;
  map<string, string> labels = 2;
}

// CheckResponse contains fields that represent decision made by Check call.
message CheckResponse {
  // decision_type contains what the decision was.
  DecisionType decision_type = 1;
  // reason contains information in the case of an error or rejection.
  Reason reason = 2;
  // limiter_decisions contains information about decision made by each limiter.
  repeated LimiterDecision limiter_decisions = 3;
  // flux meter ids that were matched for this request
  repeated string flux_meter_ids = 4;
}

message Reason {
  enum ErrorReason {
    ERROR_REASON_UNSPECIFIED = 0;
    ERROR_REASON_ENTITY_LOOKUP_FAILED = 1;
    ERROR_REASON_SERVICE_LOOKUP_FAILED = 2;
    ERROR_REASON_BAD_CLIENT_IP = 3;
  }

  enum RejectReason {
    REJECT_REASON_UNSPECIFIED = 0;
    REJECT_REASON_RATE_LIMITED = 1;
    REJECT_REASON_CONCURRENCY_LIMITED = 2;
  }

  oneof reason {
    ErrorReason error_reason = 1;
    RejectReason reject_reason = 2;
  }
}

enum DecisionType {
  DECISION_TYPE_UNSPECIFIED = 0;
  DECISION_TYPE_ACCEPTED = 1;
  DECISION_TYPE_REJECTED = 2;
}

// LimiterDecision describes details for each limiter.
message LimiterDecision {
  message RateLimiterDecision {
    string policy_name = 1;
    string policy_hash = 2;
    int64 component_index = 3;
  }

  message ConurrencyLimiterDecision {
    string policy_name = 1;
    string policy_hash = 2;
    int64 component_index = 3;
    string workload = 4;
  }

  enum LimiterReason {
    LIMITER_REASON_UNSPECIFIED = 0;
    LIMITER_REASON_KEY_NOT_FOUND = 1;
  }

  oneof decision {
    RateLimiterDecision rate_limiter_decision = 1;
    ConurrencyLimiterDecision concurrency_limiter_decision = 2;
  }
  bool dropped = 3;
  LimiterReason reason = 4;
}
