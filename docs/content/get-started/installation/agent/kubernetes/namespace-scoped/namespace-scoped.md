---
title: Namespace-scoped Installation
description: Install Aperture Agent using namespace-scoped resources
keywords:
  - install
  - setup
  - agent
  - operator
sidebar_position: 2
---

```mdx-code-block
import CodeBlock from '@theme/CodeBlock';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import {apertureVersion, apertureVersionWithOutV} from '../../../../../apertureVersion.js';
```

Aperture Agent can be installed in a single namespace without any cluster level
resources.

## Prerequisites

1. Prepare a `values.yaml` file which switches the Aperture Agent to
   namespace-scoped:

   ```yaml
   agent:
     namespaceScoped: true
   ```

2. If you want to install the Aperture Agent using `Helm` or don't want to use
   the certificates generated by `aperturectl` and want to enable
   [Agent Functions](/reference/configuration/agent.md#functions) for
   communication with the Aperture Controller, configure the ConfigMap having
   the client SSL/TLS certificate for the same in `values.yaml` file as below:

   ```yaml
   agent:
     namespaceScoped: true
     controllerCert:
       cmName: NAME_OF_CONFIGMAP
       certFileName: CERTIFICATE_FILENAME_KEY
   ```

## Installation {#agent-installation}

By following these instructions, you will have deployed the Aperture Agent into
your cluster.

1. Configure the below parameters of etcd and Prometheus for the Agent by
   updating the `values.yaml` and passing it with `install` command:

   ```yaml
   agent:
     namespaceScoped: true
     config:
       etcd:
         endpoints: ["ETCD_ENDPOINT_HERE"]
       prometheus:
         address: "PROMETHEUS_ADDRESS_HERE"
       agent_functions:
         endpoints: ["CONTROLLER_ENDPOINT_HERE"]
   ```

   If you are using
   [FluxNinja Cloud Controller](/fluxninja/introduction.md#arc-controller),
   refer to the [Configuration](/fluxninja/extension.md#configuration) section
   to get the configuration for the Aperture Agent.

   If you are using a self-hosted Aperture Controller, replace the values of
   `ETCD_ENDPOINT_HERE` and `PROMETHEUS_ADDRESS_HERE` with the actual values of
   etcd and Prometheus, which are also being used by the Aperture Controller you
   want these Agents to connect to. `CONTROLLER_ENDPOINT_HERE` should point to
   the Aperture Controller. If you skip it, some sub-commands `aperturectl`
   commands won't work.

   If you have installed the
   [Aperture Controller](/self-hosting/controller/controller.md) on the same
   cluster in `default` namespace, with etcd and Prometheus using `controller`
   as release name, the values for the values for `ETCD_ENDPOINT_HERE`,
   `PROMETHEUS_ADDRESS_HERE` and `CONTROLLER_ENDPOINT_HERE` would be as below:

   ```yaml
   agent:
     namespaceScoped: true
     config:
       etcd:
         endpoints: ["http://controller-etcd.default.svc.cluster.local:2379"]
       prometheus:
         address: "http://controller-prometheus-server.default.svc.cluster.local:80"
       agent_functions:
         endpoints: ["aperture-controller.default.svc.cluster.local:8080"]
   ```

   <Tabs groupId="setup" queryString>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl install agent --version ${apertureVersion} --values-file values.yaml`}
   </CodeBlock>
   </TabItem>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm install agent aperture/aperture-agent -f values.yaml --skip-crds`}
   </CodeBlock>
   </TabItem>
   </Tabs>

2. If you want to modify the default parameters or the Aperture Agent
   configuration, for example `log`, you can update the `values.yaml` file and
   pass it with `install` command:

   ```yaml
   agent:
     namespaceScoped: true
     config:
       etcd:
         endpoints: ["http://controller-etcd.default.svc.cluster.local:2379"]
       prometheus:
         address: "http://controller-prometheus-server.default.svc.cluster.local:80"
       log:
         level: debug
         pretty_console: true
         non_blocking: false
   ```

   <Tabs groupId="setup" queryString>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl install agent --version ${apertureVersion} --values-file values.yaml`}
   </CodeBlock>
   </TabItem>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm install agent aperture/aperture-agent -f values.yaml --skip-crds`}
   </CodeBlock>
   </TabItem>
   </Tabs>

   All the configuration parameters for the Aperture Agent are available
   [here](/reference/configuration/agent.md).

   A list of configurable parameters for the installation can be found in the
   [README](https://artifacthub.io/packages/helm/aperture/aperture-agent#parameters).

3. If you want to deploy the Aperture Agent into a namespace other than
   `default`, use the `--namespace` flag:

   <Tabs groupId="setup" queryString>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl install agent --version ${apertureVersion} --values-file values.yaml --namespace aperture-agent`}
   </CodeBlock>
   </TabItem>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm install agent aperture/aperture-agent -f values.yaml --namespace aperture-agent --create-namespace --skip-crds`}
   </CodeBlock>
   </TabItem>
   </Tabs>

## Upgrade Procedure {#agent-upgrade-procedure}

By following these instructions, you will have deployed the upgraded version of
Aperture Agent into your cluster.

1. Use the same `values.yaml` file created as part of
   [Installation Steps](#agent-installation) and pass it with below command:

   <Tabs groupId="setup" queryString>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl install agent --version ${apertureVersion} --values-file values.yaml`}
   </CodeBlock>
   </TabItem>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm template agent aperture/aperture-agent -f values.yaml | kubectl apply -f -`}
   </CodeBlock>

   Once all the pods are in a running state after upgrade, run the below command
   to keep the Helm release updated:

   <CodeBlock language="bash">
   {`helm upgrade agent aperture/aperture-agent -f values.yaml`}
   </CodeBlock>
   </TabItem>
   </Tabs>

2. If you have deployed the Aperture Agent into a namespace other than
   `default`, use the `--namespace` flag:

   <Tabs groupId="setup" queryString>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl install agent --version ${apertureVersion} --values-file values.yaml --namespace aperture-agent`}
   </CodeBlock>
   </TabItem>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm template agent aperture/aperture-agent -f values.yaml --namespace aperture-agent | kubectl apply -f -`}
   </CodeBlock>

   Once all the pods are in a running state after upgrade, run the below command
   to keep the Helm release updated:

   <CodeBlock language="bash">
   {`helm upgrade agent aperture/aperture-agent -f values.yaml --namespace aperture-agent`}
   </CodeBlock>
   </TabItem>
   </Tabs>

## Verifying the Installation

Once you have successfully deployed the resources, confirm that the Aperture
Agent is up and running:

```bash
kubectl get pod
```

You should see pods for Aperture Agent in `RUNNING` state.

## Uninstall

You can uninstall the Aperture Agent and its components installed above, by
following the below steps.

Use the same `values.yaml` file created as part of
[Installation Steps](#agent-installation) and pass it with below command.

1. Uninstall the Aperture Agent:

   <Tabs groupId="setup" queryString>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl uninstall agent --values-file values.yaml --version ${apertureVersion}`}
   </CodeBlock>
   </TabItem>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm uninstall agent -f values.yaml`}
   </CodeBlock>
   </TabItem>
   </Tabs>

2. If you have installed the chart in some other namespace than `default`,
   execute the below commands:

   <Tabs groupId="setup" queryString>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl uninstall agent --namespace aperture-agent --values-file values.yaml --version ${apertureVersion}`}
   </CodeBlock>
   </TabItem>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm uninstall agent --namespace aperture-agent -f values.yaml`}
   </CodeBlock>
   </TabItem>
   </Tabs>

3. By default, the ConfigMap generated by the `aperturectl` for client
   certificate of the Aperture Controller is not deleted with above steps. If
   you want to delete them, run the below commands:

   ```bash
   kubectl delete configmap -l app.kubernetes.io/instance=agent-aperture-agent
   ```
