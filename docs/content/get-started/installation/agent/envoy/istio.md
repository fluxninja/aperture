---
title: Istio Configuration
keywords:
  - install
  - setup
  - service mesh
  - istio
  - envoy filter
sidebar_position: 1
---

## Envoy Filter

[Envoy Filter](https://istio.io/latest/docs/reference/config/networking/envoy-filter/)
is used to customize the default configurations generated by the Istio. The
Aperture Agent requires additional details and needs the following
[Config Patches](https://istio.io/latest/docs/reference/config/networking/envoy-filter/#EnvoyFilter-EnvoyConfigObjectPatch)
to be added via the Envoy Filter.

**Note**: In all the below patches, it is presumed that the Aperture Agent is
installed with `DaemonSet` mode and is installed in the `aperture-agent`
namespace, which makes the target URL value
`aperture-agent.aperture-agent.svc.cluster.local`. If you are running the
Aperture Agent in Sidecar mode, use `localhost` as Target URL.

1. The below patch merges the
   [Access Log](https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log)
   config of type
   [Open Telemetry](https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/access_loggers/open_telemetry/v3/logs_service.proto#extensions-access-loggers-open-telemetry-v3-opentelemetryaccesslogconfig)
   with extracted values from the filter, to the
   [HTTP Connection Manager](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/http_conn_man#)
   filter for the outbound listener, in the Istio sidecar running with the
   application.

   The Open Telemetry config in the following patch has extracted values which
   get forwarded to the Aperture Agent instance using gRPC.

   The prepared log has the request method value as log body and `egress` as the
   log name to differentiate between different access logs coming from the same
   Envoy.

   ```yaml
   applyTo: NETWORK_FILTER
   match:
     context: SIDECAR_OUTBOUND
     listener:
       filterChain:
         filter:
           name: "envoy.filters.network.http_connection_manager"
   patch:
     operation: MERGE
     value:
       name: "envoy.filters.network.http_connection_manager"
       typed_config:
         "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
         access_log:
           - name: envoy.access_loggers.open_telemetry
             typed_config:
               "@type": "type.googleapis.com/envoy.extensions.access_loggers.open_telemetry.v3.OpenTelemetryAccessLogConfig"
               common_config:
                 log_name: egress
                 grpc_service:
                   google_grpc:
                     target_uri: aperture-agent.aperture-agent.svc.cluster.local:4317
                     stat_prefix: fn_otlp_access_log
                 transport_api_version: V3
               body:
                 string_value: "%REQ(:METHOD)%"
               attributes:
                 values:
                   - key: aperture.source
                     value:
                       string_value: "envoy"
                   - key: aperture.check_response
                     value:
                       string_value: "%DYNAMIC_METADATA(envoy.filters.http.ext_authz:aperture.check_response)%"
                   - key: http.status_code
                     value:
                       string_value: "%RESPONSE_CODE%"
                   - key: authz_duration
                     value:
                       string_value: "%DYNAMIC_METADATA(envoy.filters.http.ext_authz:ext_authz_duration)%"
                   - key: BYTES_RECEIVED
                     value:
                       string_value: "%BYTES_RECEIVED%"
                   - key: BYTES_SENT
                     value:
                       string_value: "%BYTES_SENT%"
                   - key: DURATION
                     value:
                       string_value: "%DURATION%"
                   - key: REQUEST_DURATION
                     value:
                       string_value: "%REQUEST_DURATION%"
                   - key: REQUEST_TX_DURATION
                     value:
                       string_value: "%REQUEST_TX_DURATION%"
                   - key: RESPONSE_DURATION
                     value:
                       string_value: "%RESPONSE_DURATION%"
                   - key: RESPONSE_TX_DURATION
                     value:
                       string_value: "%RESPONSE_TX_DURATION%"
   ```

2. The below patch also merges the
   [Access Log](https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log)
   config of type
   [Open Telemetry](https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/access_loggers/open_telemetry/v3/logs_service.proto#extensions-access-loggers-open-telemetry-v3-opentelemetryaccesslogconfig)
   to the
   [HTTP Connection Manager](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/http_conn_man#)
   filter but for the inbound listener in the Istio sidecar running with the
   application.

   The Open Telemetry config in the following patch has extracted values which
   get forwarded to the Aperture Agent instance using gRPC.

   The prepared log has the request method value as log body and `ingress` as
   the log name to differentiate between different access logs coming from the
   same Envoy.

   ```yaml
   applyTo: NETWORK_FILTER
   match:
     context: SIDECAR_INBOUND
     listener:
       filterChain:
         filter:
           name: "envoy.filters.network.http_connection_manager"
   patch:
     operation: MERGE
     value:
       name: "envoy.filters.network.http_connection_manager"
       typed_config:
         "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
         access_log:
           - name: envoy.access_loggers.open_telemetry
             typed_config:
               "@type": "type.googleapis.com/envoy.extensions.access_loggers.open_telemetry.v3.OpenTelemetryAccessLogConfig"
               common_config:
                 log_name: ingress
                 grpc_service:
                   google_grpc:
                     target_uri: aperture-agent.aperture-agent.svc.cluster.local:4317
                     stat_prefix: fn_otlp_access_log
                 transport_api_version: V3
               body:
                 string_value: "%REQ(:METHOD)%"
               attributes:
                 values:
                   - key: aperture.source
                     value:
                       string_value: "envoy"
                   - key: aperture.check_response
                     value:
                       string_value: "%DYNAMIC_METADATA(envoy.filters.http.ext_authz:aperture.check_response)%"
                   - key: http.status_code
                     value:
                       string_value: "%RESPONSE_CODE%"
                   - key: authz_duration
                     value:
                       string_value: "%DYNAMIC_METADATA(envoy.filters.http.ext_authz:ext_authz_duration)%"
                   - key: BYTES_RECEIVED
                     value:
                       string_value: "%BYTES_RECEIVED%"
                   - key: BYTES_SENT
                     value:
                       string_value: "%BYTES_SENT%"
                   - key: DURATION
                     value:
                       string_value: "%DURATION%"
                   - key: REQUEST_DURATION
                     value:
                       string_value: "%REQUEST_DURATION%"
                   - key: REQUEST_TX_DURATION
                     value:
                       string_value: "%REQUEST_TX_DURATION%"
                   - key: RESPONSE_DURATION
                     value:
                       string_value: "%RESPONSE_DURATION%"
                   - key: RESPONSE_TX_DURATION
                     value:
                       string_value: "%RESPONSE_TX_DURATION%"
   ```

3. The below patch inserts the
   [External Authorization](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/ext_authz_filter)
   before the `Router` sub-filter of the
   [HTTP Connection Manager](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/http_conn_man#)
   filter for inbound listener in the Istio sidecar running with the
   application.

   The External Authorization filter buffers the client request body with a
   maximum size of `8192` bytes, and forwards it to the Aperture Agent instance
   using gRPC with a timeout of `0.01s`, having `INBOUND` value for key
   `traffic-direction` metadata included in the streams initiated to the gRPC
   service. The filter will accept the client request even if the communication
   with the authorization service has failed, or if the authorization service
   has returned a HTTP 5xx error.

   ```yaml
   applyTo: HTTP_FILTER
   match:
     context: SIDECAR_INBOUND
     listener:
       filterChain:
         filter:
           name: "envoy.filters.network.http_connection_manager"
           subFilter:
             name: "envoy.filters.http.router"
   patch:
     operation: INSERT_BEFORE
     filterClass: AUTHZ
     value:
       name: envoy.filters.http.ext_authz
       typed_config:
         "@type": "type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz"
         transport_api_version: V3
         failure_mode_allow: true
         grpc_service:
           google_grpc:
             target_uri: aperture-agent.aperture-agent.svc.cluster.local:80
             stat_prefix: ext_authz
           timeout: 0.01s
           initial_metadata:
             - key: traffic-direction
               value: INBOUND
   ```

4. The below patch also inserts the
   [External Authorization](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/ext_authz_filter)
   before the `Router` sub-filter of the
   [HTTP Connection Manager](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/http_conn_man#)
   filter, but for outbound listener in the Istio sidecar running with the
   application.

   The External Authorization filter buffers the client request body with a
   maximum size of `8192` bytes, and forwards it to the Aperture Agent instance
   using gRPC with a timeout of `0.01s`, having `OUTBOUND` value for key
   `traffic-direction` metadata included in the streams initiated to the gRPC
   service. The filter will accept the client request even if the communication
   with the authorization service has failed, or if the authorization service
   has returned a HTTP 5xx error.

   ```yaml
   applyTo: HTTP_FILTER
   match:
     context: SIDECAR_OUTBOUND
     listener:
       filterChain:
         filter:
           name: "envoy.filters.network.http_connection_manager"
           subFilter:
             name: "envoy.filters.http.router"
   patch:
     operation: INSERT_BEFORE
     filterClass: AUTHZ
     value:
       name: envoy.filters.http.ext_authz
       typed_config:
         "@type": "type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz"
         transport_api_version: V3
         failure_mode_allow: true
         grpc_service:
           google_grpc:
             target_uri: aperture-agent.aperture-agent.svc.cluster.local:80
             stat_prefix: ext_authz
           timeout: 0.01s
           initial_metadata:
             - key: traffic-direction
               value: OUTBOUND
   ```

More information about the extracted values can be found on
[this site](https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log).
