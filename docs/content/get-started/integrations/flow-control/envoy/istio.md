---
title: Istio Configuration
keywords:
  - install
  - setup
  - service mesh
  - istio
  - envoy filter
sidebar_position: 1
---

```mdx-code-block
import CodeBlock from '@theme/CodeBlock';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import {apertureVersion, apertureVersionWithOutV} from '../../../../apertureVersion.js';
```

## Envoy Filter {#envoy-filter}

The
[Envoy Filter](https://istio.io/latest/docs/reference/config/networking/envoy-filter/)
is used to customize the default configurations generated by the Istio. The
Aperture Agent requires additional details and needs the following
[Configuration Patches](https://istio.io/latest/docs/reference/config/networking/envoy-filter/#EnvoyFilter-EnvoyConfigObjectPatch)
to be added through the Envoy Filter.

**Note**: In all the below patches, it is presumed that the Aperture Agent is
installed with `DaemonSet` mode and is installed in the `aperture-agent`
namespace, which makes the target address value
`aperture-agent.aperture-agent.svc.cluster.local`. If you are running the
Aperture Agent in Sidecar mode, use `localhost` as the target address.

1. The below patch merges the
   [Access Log](https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log)
   configuration of type
   [Open Telemetry](https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/access_loggers/open_telemetry/v3/logs_service.proto#extensions-access-loggers-open-telemetry-v3-opentelemetryaccesslogconfig)
   with extracted values from the filter, to the
   [HTTP Connection Manager](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/http_conn_man#)
   filter for the outbound listener, in the Istio sidecar running with the
   application.

   The Open Telemetry configuration in the following patch has extracted values,
   which are forwarded to the Aperture Agent instance using gRPC.

   The prepared log has the request method value as log body and `egress` as the
   log name to differentiate between different access logs coming from the same
   Envoy.

   ```yaml
   applyTo: NETWORK_FILTER
   match:
     context: SIDECAR_OUTBOUND
     listener:
       filterChain:
         filter:
           name: "envoy.filters.network.http_connection_manager"
   patch:
     operation: MERGE
     value:
       name: "envoy.filters.network.http_connection_manager"
       typed_config:
         "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
         access_log:
           - name: envoy.access_loggers.open_telemetry
             typed_config:
               "@type": "type.googleapis.com/envoy.extensions.access_loggers.open_telemetry.v3.OpenTelemetryAccessLogConfig"
               common_config:
                 log_name: egress
                 grpc_service:
                   google_grpc:
                     target_uri: aperture-agent.aperture-agent.svc.cluster.local:4317
                     stat_prefix: fn_otlp_access_log
                 transport_api_version: V3
               body:
                 string_value: "%REQ(:METHOD)%"
               attributes:
                 values:
                   - key: aperture.source
                     value:
                       string_value: "envoy"
                   - key: aperture.check_response
                     value:
                       string_value: "%DYNAMIC_METADATA(envoy.filters.http.ext_authz:aperture.check_response)%"
                   - key: http.status_code
                     value:
                       string_value: "%RESPONSE_CODE%"
                   - key: authz_duration
                     value:
                       string_value: "%DYNAMIC_METADATA(envoy.filters.http.ext_authz:ext_authz_duration)%"
                   - key: BYTES_RECEIVED
                     value:
                       string_value: "%BYTES_RECEIVED%"
                   - key: BYTES_SENT
                     value:
                       string_value: "%BYTES_SENT%"
                   - key: DURATION
                     value:
                       string_value: "%DURATION%"
                   - key: REQUEST_DURATION
                     value:
                       string_value: "%REQUEST_DURATION%"
                   - key: REQUEST_TX_DURATION
                     value:
                       string_value: "%REQUEST_TX_DURATION%"
                   - key: RESPONSE_DURATION
                     value:
                       string_value: "%RESPONSE_DURATION%"
                   - key: RESPONSE_TX_DURATION
                     value:
                       string_value: "%RESPONSE_TX_DURATION%"
   ```

2. The below patch also merges the
   [Access Log](https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log)
   configuration of type
   [Open Telemetry](https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/access_loggers/open_telemetry/v3/logs_service.proto#extensions-access-loggers-open-telemetry-v3-opentelemetryaccesslogconfig)
   to the
   [HTTP Connection Manager](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/http_conn_man#)
   filter, but for the inbound listener in the Istio sidecar running with the
   application.

   The Open Telemetry configuration in the following patch has extracted values,
   which are forwarded to the Aperture Agent instance using gRPC.

   The prepared log has the request method value as log body and `ingress` as
   the log name to differentiate between different access logs coming from the
   same Envoy.

   ```yaml
   applyTo: NETWORK_FILTER
   match:
     context: SIDECAR_INBOUND
     listener:
       filterChain:
         filter:
           name: "envoy.filters.network.http_connection_manager"
   patch:
     operation: MERGE
     value:
       name: "envoy.filters.network.http_connection_manager"
       typed_config:
         "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
         access_log:
           - name: envoy.access_loggers.open_telemetry
             typed_config:
               "@type": "type.googleapis.com/envoy.extensions.access_loggers.open_telemetry.v3.OpenTelemetryAccessLogConfig"
               common_config:
                 log_name: ingress
                 grpc_service:
                   google_grpc:
                     target_uri: aperture-agent.aperture-agent.svc.cluster.local:4317
                     stat_prefix: fn_otlp_access_log
                 transport_api_version: V3
               body:
                 string_value: "%REQ(:METHOD)%"
               attributes:
                 values:
                   - key: aperture.source
                     value:
                       string_value: "envoy"
                   - key: aperture.check_response
                     value:
                       string_value: "%DYNAMIC_METADATA(envoy.filters.http.ext_authz:aperture.check_response)%"
                   - key: http.status_code
                     value:
                       string_value: "%RESPONSE_CODE%"
                   - key: authz_duration
                     value:
                       string_value: "%DYNAMIC_METADATA(envoy.filters.http.ext_authz:ext_authz_duration)%"
                   - key: BYTES_RECEIVED
                     value:
                       string_value: "%BYTES_RECEIVED%"
                   - key: BYTES_SENT
                     value:
                       string_value: "%BYTES_SENT%"
                   - key: DURATION
                     value:
                       string_value: "%DURATION%"
                   - key: REQUEST_DURATION
                     value:
                       string_value: "%REQUEST_DURATION%"
                   - key: REQUEST_TX_DURATION
                     value:
                       string_value: "%REQUEST_TX_DURATION%"
                   - key: RESPONSE_DURATION
                     value:
                       string_value: "%RESPONSE_DURATION%"
                   - key: RESPONSE_TX_DURATION
                     value:
                       string_value: "%RESPONSE_TX_DURATION%"
   ```

3. The below patch inserts the
   [External Authorization](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/ext_authz_filter)
   before the `Router` sub-filter of the
   [HTTP Connection Manager](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/http_conn_man#)
   filter for inbound listener in the Istio sidecar running with the
   application.

   The External Authorization filter forwards the request to the Aperture Agent
   instance using gRPC with a timeout of `0.5s`, having `ingress` value for key
   `control-point` metadata included in the streams initiated to the gRPC
   service. The filter will accept the client request even if the communication
   with the authorization service has failed, or if the authorization service
   has returned an HTTP 5xx error.

   ```yaml
   applyTo: HTTP_FILTER
   match:
     context: SIDECAR_INBOUND
     listener:
       filterChain:
         filter:
           name: "envoy.filters.network.http_connection_manager"
           subFilter:
             name: "envoy.filters.http.router"
   patch:
     operation: INSERT_BEFORE
     filterClass: AUTHZ
     value:
       name: envoy.filters.http.ext_authz
       typed_config:
         "@type": "type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz"
         transport_api_version: V3
         failure_mode_allow: true
         grpc_service:
           google_grpc:
             target_uri: aperture-agent.aperture-agent.svc.cluster.local:80
             stat_prefix: ext_authz
           timeout: 0.5s
           initial_metadata:
             - key: control-point
               value: ingress
   ```

4. The below patch also inserts the
   [External Authorization](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/ext_authz_filter)
   before the `Router` sub-filter of the
   [HTTP Connection Manager](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/http_conn_man#)
   filter, but for the outbound listener in the Istio sidecar running with the
   application.

   The External Authorization filter forwards the request to the Aperture Agent
   instance using gRPC with a timeout of `0.5s`, having `egress` value for key
   `control-point` metadata included in the streams initiated to the gRPC
   service. The filter will accept the client request even if the communication
   with the authorization service has failed, or if the authorization service
   has returned an HTTP 5xx error.

   ```yaml
   applyTo: HTTP_FILTER
   match:
     context: SIDECAR_OUTBOUND
     listener:
       filterChain:
         filter:
           name: "envoy.filters.network.http_connection_manager"
           subFilter:
             name: "envoy.filters.http.router"
   patch:
     operation: INSERT_BEFORE
     filterClass: AUTHZ
     value:
       name: envoy.filters.http.ext_authz
       typed_config:
         "@type": "type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz"
         transport_api_version: V3
         failure_mode_allow: true
         grpc_service:
           google_grpc:
             target_uri: aperture-agent.aperture-agent.svc.cluster.local:80
             stat_prefix: ext_authz
           timeout: 0.5s
           initial_metadata:
             - key: control-point
               value: egress
   ```

More information about the extracted values can be found on
[this site](https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log).

## Prerequisites

You can do the installation using the `aperturectl` CLI tool or using `Helm`.
Install the tool of your choice using the following links:

1. [aperturectl](/get-started/aperture-cli/aperture-cli.md)

   :::info Refer

   [aperturectl install controller](/reference/aperturectl/install/controller/controller.md)
   to see all the available command line arguments.

   :::

2. [Helm](https://helm.sh/docs/intro/install/)

   1. Once the Helm CLI is installed, add the
      [Aperture istioconfig Helm Repository](https://artifacthub.io/packages/helm/aperture/istioconfig)
      in your environment for installation:

      ```bash
      helm repo add aperture https://fluxninja.github.io/aperture/
      helm repo update
      ```

## Installation

Below are the steps to install or upgrade the example Istio EnvoyFilter into
your setup using the
[Aperture istioconfig Helm chart](https://artifacthub.io/packages/helm/aperture/istioconfig).

By following these instructions, you will have installed the Istio EnvoyFilter
into your cluster.

1. Execute the below command to install or upgrade the Istio EnvoyFilter:

   :::info

   Replace the value of `ISTIOD_NAMESPACE_HERE` with the namespace in which
   `istiod` is running. This way, the Istio EnvoyFilter will be applied to all
   the pods having Istio sidecar injected across namespaces.

   If you want to apply the Istio EnvoyFilter to a particular namespace, replace
   the value of `ISTIOD_NAMESPACE_HERE` with that namespace.

   :::

   <Tabs groupId="setup" queryString>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl install istioconfig --version ${apertureVersion} --namespace ISTIOD_NAMESPACE_HERE`}
   </CodeBlock>
   </TabItem>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm upgrade --install aperture-envoy-filter aperture/istioconfig --namespace ISTIOD_NAMESPACE_HERE`}
   </CodeBlock>
   </TabItem>
   </Tabs>

   The default values for the Aperture Agent service namespace is
   `aperture-agent`, port is `8080` and sidecar mode is `false`. This makes the
   Aperture Agent target address
   `aperture-agent.aperture-agent.svc.cluster.local:8080`. If you have installed
   the Aperture Agent in a different namespace or different port, you can create
   or update the `values.yaml` file and pass it with the `install` command:

   ```yaml
   envoyFilter:
     namespace: APERTURE_AGENT_NAMESPACE_HERE
     port: APERTURE_AGENT_SERVER_PORT_HERE
   ```

   <Tabs groupId="setup" queryString>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl install istioconfig --version ${apertureVersion} --namespace ISTIOD_NAMESPACE_HERE --values-file values.yaml`}
   </CodeBlock>
   </TabItem>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm upgrade --install aperture-envoy-filter aperture/istioconfig --namespace ISTIOD_NAMESPACE_HERE -f values.yaml`}
   </CodeBlock>
   </TabItem>
   </Tabs>

2. If you want to modify the default parameters of the chart, for example
   `sidecarMode`, you can create or update the `values.yaml` file and pass it
   with `install` command:

   ```yaml
   envoyFilter:
     sidecarMode: true
   ```

   <Tabs groupId="setup" queryString>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl install istioconfig --version ${apertureVersion} --namespace ISTIOD_NAMESPACE_HERE --values-file values.yaml`}
   </CodeBlock>
   </TabItem>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm upgrade --install aperture-envoy-filter aperture/istioconfig --namespace ISTIOD_NAMESPACE_HERE -f values.yaml`}
   </CodeBlock>
   </TabItem>
   </Tabs>

   A list of configurable parameters for the installation can be found in the
   [README](https://artifacthub.io/packages/helm/aperture/istioconfig#parameters).

## Verifying the Installation

Once you have successfully deployed the resources, confirm that the Istio
EnvoyFilter is created:

```bash
kubectl get envoyfilter aperture-envoy-filter -n ISTIOD_NAMESPACE_HERE
```

You should see a Kubernetes custom resource for the Istio EnvoyFilter.

## Uninstall

You can uninstall the Istio EnvoyFilter installed above by following the
following steps:

1. Uninstall the Aperture istioconfig:

   <Tabs groupId="setup" queryString>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl uninstall istioconfig`}
   </CodeBlock>
   </TabItem>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm uninstall aperture-envoy-filter`}
   </CodeBlock>
   </TabItem>
   </Tabs>
