---
title: Namespace-scoped Installation
description: Install Aperture Agent using namespace-scoped resources
keywords:
  - install
  - setup
  - agent
  - operator
sidebar_position: 1
---

```mdx-code-block
import CodeBlock from '@theme/CodeBlock';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import {apertureVersion, apertureVersionWithOutV} from '../../../../../apertureVersion.js';
```

Aperture Agent can be installed in a single namespace without any cluster level
resources.

## Prerequisites

You can do the installation using the `aperturectl` CLI tool or using `Helm`.
Install the tool of your choice using the following links:

1. [Helm](https://helm.sh/docs/intro/install/)

   1. Once the Helm CLI is installed, add the
      [Aperture Agent Helm chart](https://artifacthub.io/packages/helm/aperture/aperture-agent)
      repository in your environment for install or upgrade:

      ```bash
      helm repo add aperture https://fluxninja.github.io/aperture/
      helm repo update
      ```

2. [aperturectl](/get-started/setup-cli/setup-cli.md)

   :::info Refer

   [aperturectl install agent](/reference/aperturectl/install/agent/agent.md) to
   see all the available command line arguments.

   :::

Prepare a `values.yaml` file which switches the Aperture Agent to
namespace-scoped:

```yaml
agent:
  namespaceScoped: true
```

:::note

(Relevant to
[Self-Hosted Aperture Controller](/get-started/self-hosting/self-hosting.md)
only, ignore this note if using Aperture Cloud Controller).

If you want to install the Aperture Agent using `Helm` or don't want to use the
certificates generated by `aperturectl` and want to enable
[Agent Functions](/reference/configuration/agent.md#functions) for communication
with the Aperture Controller, configure the ConfigMap having the client SSL/TLS
certificate for the same in `values.yaml` file as below:

```yaml
agent:
  namespaceScoped: true
  controllerCert:
    cmName: NAME_OF_CONFIGMAP
    certFileName: CERTIFICATE_FILENAME_KEY
```

:::

## Installation {#agent-installation}

By following these instructions, you will have deployed the Aperture Agent into
your cluster.

1. Configure the Aperture Cloud endpoint and Agent Key parameters in the Agent.
   Update the `values.yaml` file and pass it with the `install` command:

   ```yaml
   agent:
     namespaceScoped: true
     config:
       fluxninja:
         enable_cloud_controller: true
         endpoint: "ORGANIZATION_NAME.app.fluxninja.com:443"
     secrets:
       fluxNinjaExtension:
         create: true
         secretKeyRef:
           name: aperture-agent-apikey
           key: apiKey
         value: AGENT_API_KEY
   ```

   Replace `ORGANIZATION_NAME` with the Aperture Cloud organization name and
   `AGENT_API_KEY` with the API key linked to the project. If an API key has not
   been created, generate a new one through the Aperture Cloud UI. Refer to [API
   Keys][agent-api-keys] for additional information.

   :::note

   If you are using a Self-Hosted Aperture Controller, modify the above
   configuration as explained in
   [Self-Hosting: Agent Configuration](/get-started/self-hosting/agent/agent.md#agent-self-hosted-controller).

   :::

   <Tabs groupId="setup" queryString>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm install agent aperture/aperture-agent -f values.yaml --skip-crds`}
   </CodeBlock>
   </TabItem>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl install agent --version ${apertureVersion} --values-file values.yaml`}
   </CodeBlock>
   </TabItem>
   </Tabs>

2. If you want to modify the default parameters or the Aperture Agent
   configuration, for example `log`, you can update the `values.yaml` file and
   pass it with `install` command:

   ```yaml
   agent:
     namespaceScoped: true
     config:
       fluxninja:
         enable_cloud_controller: true
         endpoint: "ORGANIZATION_NAME.app.fluxninja.com:443"
       log:
         level: debug
         pretty_console: true
         non_blocking: false
     secrets:
       fluxNinjaExtension:
         create: true
         secretKeyRef:
           name: aperture-agent-apikey
           key: apiKey
         value: AGENT_API_KEY
   ```

   <Tabs groupId="setup" queryString>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm install agent aperture/aperture-agent -f values.yaml --skip-crds`}
   </CodeBlock>
   </TabItem>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl install agent --version ${apertureVersion} --values-file values.yaml`}
   </CodeBlock>
   </TabItem>
   </Tabs>

   All the configuration parameters for the Aperture Agent are available
   [here](/reference/configuration/agent.md).

   A list of configurable parameters for the installation can be found in the
   [README](https://artifacthub.io/packages/helm/aperture/aperture-agent#parameters).

3. To deploy the Aperture Agent into a namespace other than `default`, use the
   `--namespace` flag:

   <Tabs groupId="setup" queryString>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm install agent aperture/aperture-agent -f values.yaml --namespace aperture-agent --create-namespace --skip-crds`}
   </CodeBlock>
   </TabItem>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl install agent --version ${apertureVersion} --values-file values.yaml --namespace aperture-agent`}
   </CodeBlock>
   </TabItem>
   </Tabs>

## Upgrade Procedure {#agent-upgrade-procedure}

By following these instructions, you will have deployed the upgraded version of
Aperture Agent into your cluster.

1. Use the same `values.yaml` file created as part of the
   [Installation Steps](#agent-installation) and pass it with below command:

   <Tabs groupId="setup" queryString>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm template agent aperture/aperture-agent -f values.yaml | kubectl apply -f -`}
   </CodeBlock>

   Once all the pods are in a running state after upgrade, run the below command
   to keep the Helm release updated:

   <CodeBlock language="bash">
   {`helm upgrade agent aperture/aperture-agent -f values.yaml`}
   </CodeBlock>
   </TabItem>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl install agent --version ${apertureVersion} --values-file values.yaml`}
   </CodeBlock>
   </TabItem>
   </Tabs>

2. If you have deployed the Aperture Agent into a namespace other than
   `default`, use the `--namespace` flag:

   <Tabs groupId="setup" queryString>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm template agent aperture/aperture-agent -f values.yaml --namespace aperture-agent | kubectl apply -f -`}
   </CodeBlock>

   Once all the pods are in a running state after upgrade, run the below command
   to keep the Helm release updated:

   <CodeBlock language="bash">
   {`helm upgrade agent aperture/aperture-agent -f values.yaml --namespace aperture-agent`}
   </CodeBlock>
   </TabItem>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl install agent --version ${apertureVersion} --values-file values.yaml --namespace aperture-agent`}
   </CodeBlock>
   </TabItem>
   </Tabs>

## Verifying the Installation

Once you have successfully deployed the resources, confirm that the Aperture
Agent is up and running:

```bash
kubectl get pod
```

You should see pods for Aperture Agent in `RUNNING` state.

## Uninstall

You can uninstall the Aperture Agent and its components installed above, by
following the below steps.

Use the same `values.yaml` file created as part of the
[Installation Steps](#agent-installation) and pass it with the below command.

1. Uninstall the Aperture Agent:

   <Tabs groupId="setup" queryString>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm uninstall agent -f values.yaml`}
   </CodeBlock>
   </TabItem>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl uninstall agent --values-file values.yaml --version ${apertureVersion}`}
   </CodeBlock>
   </TabItem>
   </Tabs>

2. If you have installed the chart in some other namespace than `default`,
   execute the commands below:

   <Tabs groupId="setup" queryString>
   <TabItem value="Helm" label="Helm">
   <CodeBlock language="bash">
   {`helm uninstall agent --namespace aperture-agent -f values.yaml`}
   </CodeBlock>
   </TabItem>
   <TabItem value="aperturectl" label="aperturectl">
   <CodeBlock language="bash">
   {`aperturectl uninstall agent --namespace aperture-agent --values-file values.yaml --version ${apertureVersion}`}
   </CodeBlock>
   </TabItem>
   </Tabs>

3. By default, the ConfigMap generated by the `aperturectl` for the client
   certificate of the Aperture Controller is not deleted with the above steps.
   If you want to delete them, run the commands below:

   ```bash
   kubectl delete configmap -l app.kubernetes.io/instance=agent-aperture-agent
   ```

[agent-api-keys]: /get-started/aperture-cloud/agent-api-keys.md
