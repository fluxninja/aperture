---
title: GraphQL Query Rate Limiting
keywords:
  - policies
  - ratelimit
  - graphql
sidebar_position: 1
---

```mdx-code-block
import {apertureVersion} from '../../../apertureVersion.js';
import CodeBlock from '@theme/CodeBlock';
import Tabs from '@theme/Tabs';
import TabItem from "@theme/TabItem";
import {BashTab, TabContent} from '../blueprintsComponents.js';
import Zoom from 'react-medium-image-zoom';
```

## Overview

This policy is an example of how to implement
[rate limiting](/reference/blueprints/rate-limiting/base.md) for GraphQL queries
using the [_Classifier_][rego-rules].

## Configuration

This policy is based on the
[Rate Limiting](/reference/blueprints/rate-limiting/base.md) blueprint. It
contains a [_Classifier_][classifier] that extracts the **`userID`** claim from
a JWT token in the request's authorization header and then rate limit unique
users based on the extracted **`user_id`** [_Flow Label_][flow-label];
**`todo-service.prod.svc.cluster.local`** is selected as the target service for
this policy.

:::tip

Classification rules can be written based on
[HTTP requests](/concepts/advanced/classifier.md#live-previewing-requests), and
scheduler priorities can be defined based on
[Flow Labels](/concepts/flow-label.md#live-previewing-flow-labels) by live
previewing them first using introspection APIs.

:::

The below `values.yaml` file can be generated by following the steps in the
[Installation](#installation) section.

```mdx-code-block
<Tabs>
<TabItem value="aperturectl values.yaml">
```

```yaml
{@include: ./assets/graphql/values.yaml}
```

```mdx-code-block
</TabItem>
</Tabs>
```

<details><summary>Generated Policy</summary>
<p>

```yaml
{@include: ./assets/graphql/policy.yaml}
```

</p>
</details>

:::info

[Circuit Diagram](./assets/graphql/graph.mmd.svg) for this policy.

:::

For example, if the mutation query is as follows

```graphql
mutation createTodo {
  createTodo(input: { text: "todo" }) {
    user {
      id
    }
    text
    done
  }
}
```

Without diving deep into how Rego works, the source section mentioned in this
use-case does the following:

1. Parse the query
2. Check if the mutation query is `createTodo`
3. Verify the JWT token with a secret key `secret` (only for demonstration
   purposes)
4. Decode the JWT token and extract the `userID` from the claims
5. Assign the value of `userID` to the exported variable `userID` in Rego source

From there on, the Classifier rule assigns the value of the exported variable
`userID` in Rego source to `user_id` flow label, effectively creating a label
`user_id:1`. This label is used by the
[`Rate Limiter`](/concepts/rate-limiter.md) component in the policy to limit the
`createTodo` mutation query to `2` requests per second, with a burst capacity of
`40` requests for each `userID`.

## Installation

Generate a values file specific to the policy. This can be achieved using the
command provided below.

```mdx-code-block
<CodeBlock language="bash">aperturectl blueprints values --name=rate-limiting/base --version={apertureVersion} --output-file=values.yaml</CodeBlock>
```

Apply the policy using the `aperturectl` CLI or `kubectl`.

```mdx-code-block
<Tabs>
  <TabItem value="aperturectl (Aperture Cloud)" label="aperturectl (Aperture Cloud)">
    <TabContent valuesFile="values" tabValue="aperturectl (Aperture Cloud)" />
  </TabItem>
  <TabItem value="aperturectl (self-hosted controller)" label="aperturectl (self-hosted controller)">
```

Pass the `--kube` flag with `aperturectl` to directly apply the generated policy
on a Kubernetes cluster in the namespace where the Aperture Controller is
installed.

```mdx-code-block
  <TabContent valuesFile="values" tabValue="aperturectl (self-hosted controller)" policyName="graphql-rate-limiting" />
</TabItem>
<TabItem value="kubectl (self-hosted controller)" label="kubectl (self-hosted controller)">
```

Apply the generated policy YAML (Kubernetes Custom Resource) with `kubectl`.

```mdx-code-block
  <TabContent valuesFile="values" tabValue="kubectl (self-hosted controller)" policyName="graphql-rate-limiting" />
</TabItem>

</Tabs>
```

## Policy in Action

In this example, the traffic generator is configured to generate `50` requests
per second for 2-minutes. When loading the above policy in the playground, you
can observe that it accepts no more than `2` requests per second at any given
time, and rejects the rest of the requests.

![GraphQL Status Rate Limiting](./assets/graphql/dashboard.png)

[rego-rules]: /concepts/advanced/classifier.md#rego
[flow-label]: /concepts/flow-label.md
[classifier]: /concepts/advanced/classifier.md
