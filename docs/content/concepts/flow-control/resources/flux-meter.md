---
title: Flux Meter
sidebar_position: 2
keywords:
  - fluxmeter
  - histograms
---

:::info

See also [_Flux Meter_ reference][reference]

:::

## Purpose

The _Flux Meter_ provides a way to translate a flux of flows matching a [Flow
Selector][flow-selector] to a Prometheus [histogram][histogram-metric].

## Naming

_Flux Meter_ is referred to by its name. It's strongly recommended to assign
globally unique names to _Flux Meters_. A good practice is to prefix the Flux
Meter name with the policy name.

:::caution warning

_Flux Meters_ with repeated names within the same
[_Agent Group_](/concepts/flow-control/flow-selector.md#agent-group) will fail
to load at the agents.

:::

## Metric

The default metric tracked by _Flux Meter_ is the flow's workload duration in
milliseconds. The _Flux Meter_ may be configured to track any arbitrary metric
coming via OpenTelemetry attributes on log or span telemetry streams based on
the [insertion method][flow-control-insertion]. For instance, any of the metrics
defined in the Envoy [access log specification][envoy-access-log-spec] may be
used by _Flux Meter_.

## Buckets

The buckets used by histogram metric can be provided as configuration to _Flux
Meter_. Buckets effect the accuracy of [quantile][quantiles] calculations at
_Prometheus_ via [PromQL][promql-reference]. _Prometheus_ recommends defining
buckets close to the actual distribution of metric values to achieve good
accuracy.

:::note

Buckets are needed only for quantile queries, for example, getting the 95th
percentile of duration across pods in a service. The buckets don't matter if you
are only interested in the average duration or throughput metrics from a _Flux
Meter_.

:::

## Usage

_PromQL_ components can refer to the metrics generated by _Flux Meter_. The
histogram metric generated via _Flux Meter_ is named `flux_meter` and has the
following labels:

1. `flux_meter_name`: Name of the _Flux Meter_ metric
2. `decision_type`: Flow control decision from Agent
3. `status_code`: HTTP status code of the flow. Relevant only for traffic-based
   _Control Points_.
4. `flow_status`: Protocol independent status for the flow.
5. Other common labels available at all agents, such as `instance`.

:::info

For more details, please
[refer to metrics and labels](/reference/observability/prometheus-metrics/agent.md#flux-meter)
collected by _Flux Meters_.

:::

Query to get average duration (assuming default _Flux Meter_ metric):

```promql
sum(increase(flux_meter_sum{flux_meter_name=\"<name>\"}[10s]))/sum(increase(flux_meter_count{flux_meter_name=\"<name>\"}[10s]))
```

Query to get requests per second:

```promql
sum(rate(flux_meter_count{flux_meter_name=\"<name>\"}[10s]))
```

Query to get 95th percentile of duration:

```promql
histogram_quantile(0.95, sum(rate(flux_meter_bucket{flux_meter_name=\"<name>\"}[5m])) by (le))
```

[PromQL Components][promql-reference] in a Circuit can use the _Flux Meter_
metric in a PromQL query as described above. The PromQL Component generates a
[signal][signal] representing the results of the PromQL query.

### Control Loop

A Control Loop can use a duration Signal generated via the _Flux Meter_ metric
as a signal to a Controller which determines the desired Concurrency of a
Service.

### Observability

_Flux Meters_ are a great way to measure [SLOs][google-sre-slo] of your Service
down to fine-grained APIs attributes such as endpoints, user types (subscriber
vs. logged out).

[reference]: /reference/policies/spec.md#flux-meter
[flow-selector]: /concepts/flow-control/flow-selector.md
[flow-control-insertion]: ../flow-control.md#insertion
[histogram-metric]: https://prometheus.io/docs/practices/histograms/
[quantiles]: https://prometheus.io/docs/practices/histograms/#quantiles
[envoy-access-log-spec]:
  https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators
[promql-reference]: /reference/policies/spec.md#prom-q-l
[signal]: /concepts/policy/circuit.md#signal
[google-sre-slo]: https://sre.google/workbook/implementing-slos/
