---
title: Flux Meter
sidebar_position: 6
keywords:
  - fluxmeter
  - histograms
---

:::info

See also [Flux Meter reference][reference]

:::

## Purpose

Flux Meter provides a way to translate a Flux of [Flows][flow] matching a
[Selector][selector] to a Prometheus [Histogram Metric][histogram-metric].

## Naming

Flux Meter is referred by its name. It is strongly recommended to assign
globally unique names to Flux Meters. A good practice is to prefix the Flux
Meter name with the Policy name.

:::caution warning

Flux Meters with repeated names within the same Agent Group will fail to load at
Agents.

:::

## Metric

The default metric tracked by Flux Meter is the Flow's workload duration in
milliseconds. The FluxMeter may be configured to track any arbitrary metric
coming via OpenTelemetry attributes on log or span telemetry streams from a
[Flow Control Integration][flow-control-integration]. For instance, any of the
metrics defined in the Envoy [access log specification][envoy-access-log-spec]
may be used by Flux Meter.

## Buckets

The buckets used by Histogram metric can be provided as configuration to Flux
Meter. Buckets effect the accuracy of [quantile][quantiles] calculations at
Prometheus via PromQL. Prometheus recommends defining buckets close to the
actual distribution of metric values to achieve good accuracy.

:::note

Buckets are needed only for quantile queries e.g. getting the 95th percentile of
duration across pods in a Service. The buckets don't matter if you are only
interested in the average duration or throughput metrics from a flux meter.

:::

## Usage

PromQL Components can refer to the metrics generated by Flux Meter. The
histogram metric generated via Flux Meter is named `flux_meter` and has the
following labels:

1. `flux_meter_name`: Name of the Flux Meter metric
2. `decision_type`: Flow Control decision from Agent
<!-- TODO tgill: update once we start following OTEL semantic convention on metric labels -->
3. `status_code`: HTTP status code of the Flow. Relevant only for Traffic based
   Control Points.
4. `feature_status`: Status from SDK. Relevant only for Feature based Control
   Points.
5. Other common labels available at all Agent such as `instance`.

Query to get average duration (assuming default Flux Meter metric):

```
sum(increase(flux_meter_sum{flux_meter_name=\"<name>\"}[10s]))/sum(increase(flux_meter_count{flux_meter_name=\"<name>\"}[10s]))
```

Query to get requests per second:

```
sum(rate(flux_meter_count{flux_meter_name=\"<name>\"}[10s]))
```

Query to get 95th percentile of duration:

```
histogram_quantile(0.95, sum(rate(flux_meter_bucket{flux_meter_name=\"<name>\"}[5m])) by (le))
```

[PromQL Components][promql-reference] in a Circuit can use Flux Meter metric in
a PromQL query as described above. The PromQL Component generates a
[Signal][signal] representing the results of the PromQL query.

### Control Loop

A Control Loop can use a duration Signal generated via the Flux Meter metric as
signal to a Controller which determines the desired Concurrency of a Service.

### Standalone Observability

Flux Meters are a great way to measure [SLOs][google-sre-slo] of your Service
down to fine-grained APIs.

[reference]: /reference/configuration/policies.md#policylanguagev1-flux-meter
[flow]: /concepts/flow-control/flow-control.md#flow
[selector]: /concepts/flow-control/selector/selector.md
[flow-control-integration]: /concepts/flow-control/flow-control.md#integrations
[histogram-metric]: https://prometheus.io/docs/practices/histograms/
[quantiles]: https://prometheus.io/docs/practices/histograms/#quantiles
[envoy-access-log-spec]: https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators
[promql-reference]: /reference/configuration/policies.md#v1-prom-q-l
[signal]: /concepts/policy/circuit.md#signal
[google-sre-slo]: https://sre.google/workbook/implementing-slos/
