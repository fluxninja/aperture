---
title: Flux Meter
sidebar_position: 8
keywords:
  - fluxmeter
  - histograms
---

:::info See also

[_Flux Meter_ reference][reference]

:::

The _Flux Meter_ is a type of policy resource that provides a way to translate a
flux of flows, matching a [Selector][flow-selectors], into a Prometheus
[histogram][histogram-metric]. The histogram created by _Flux Meter_ measures
the workload latency by default.

Example:

```yaml
flux_meters:
  cart-service1-app:
    selectors:
      - control_point: cart-service2-app
        label_matcher:
          match_labels:
            http.target: /service3
        service: kong-server.demoapp.svc.cluster.local
```

## Naming Convention

Each _Flux Meter_ is identified by its unique name. The generated histogram gets
labeled with this name. It is therefore recommended to assign globally unique
names to _Flux Meters_.

## The Journey of a Request

This diagram details the journey of a request, as it traverses through the
selectors which forward the request to the matching _Flux Meters_.

![Flux Meter](./assets/img/flux-meter-light.svg#gh-light-mode-only)
![Flux Meter](./assets/img/flux-meter-dark.svg#gh-dark-mode-only)

In addition to the _Flux Meters_ shown in the diagram, the request might get
processed by other matching flow control components before a decision is
returned to the service. The service executes its logic based on the decision,
and an OpenTelemetry span representing the flow gets generated and forwarded to
the Agent. The OTel pipeline in the Agent processes the span(s) and reports the
generated metrics to Prometheus.

## Metric

The default metric tracked by _Flux Meter_ is the flow's workload duration in
milliseconds. The _Flux Meter_ might be configured to track any arbitrary metric
from OpenTelemetry attributes on the span or log streams. For instance, any of
the metrics defined in the Envoy [access log
specification][envoy-access-log-spec] might be used by _Flux Meter_.

## Buckets

The buckets used by histogram metric can be provided as configuration to _Flux
Meter_. Buckets effect the accuracy of [quantile][quantiles] calculations at
_Prometheus_ through [PromQL][promql-reference]. _Prometheus_ recommends
defining buckets close to the actual distribution of metric values to achieve
good accuracy.

:::note

Buckets are needed only for quantile queries, for example, getting the 95th
percentile of duration across pods in a service. The buckets do not matter if
you are only interested in the average duration or throughput metrics from a
_Flux Meter_.

:::

## Usage

_PromQL_ components can refer to the metrics generated by _Flux Meter_. The
histogram metric generated by _Flux Meter_ is named `flux_meter` and has the
following labels:

1. `flux_meter_name`: Name of the _Flux Meter_ metric
2. `decision_type`: Flow control decision from Agent
3. `http_status_code`: HTTP status code of the flow. Relevant only for
   traffic-based _Control Points_.
4. `flow_status`: Protocol independent status for the flow.
5. Other common labels available at all Agents, such as `instance`.

:::info

For more details, please
[refer to metrics and labels](/reference/observability/prometheus-metrics/agent.md#flux-meter)
collected by _Flux Meters_.

:::

Query to get average duration (assuming default _Flux Meter_ metric):

```promql
sum(increase(flux_meter_sum{flux_meter_name=\"<name>\"}[10s]))/sum(increase(flux_meter_count{flux_meter_name=\"<name>\"}[10s]))
```

Query to get requests per second:

```promql
sum(rate(flux_meter_count{flux_meter_name=\"<name>\"}[10s]))
```

Query to get 95th percentile of duration:

```promql
histogram_quantile(0.95, sum(rate(flux_meter_bucket{flux_meter_name=\"<name>\"}[5m])) by (le))
```

[PromQL Components][promql-reference] in a Circuit can use the _Flux Meter_
metric in a PromQL query as described above. The PromQL Component generates a
[signal][signal] representing the results of the PromQL query.

### Use cases

- Control: A control loop can use a duration signal generated using the _Flux
  Meter_ metric as a signal to throttle the request rate at a service or to stop
  a feature rollout.
- Observability: _Flux Meters_ can measure and alert on [SLOs][google-sre-slo]
  of a service down to fine-grained API attributes such as endpoints, user types
  (subscriber user compared to guest user).

[reference]: /reference/configuration/spec.md#flux-meter
[flow-selectors]: /concepts/selector.md
[histogram-metric]: https://prometheus.io/docs/practices/histograms/
[quantiles]: https://prometheus.io/docs/practices/histograms/#quantiles
[envoy-access-log-spec]:
  https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators
[promql-reference]: /reference/configuration/spec.md#prom-q-l
[signal]: /concepts/advanced/circuit.md#signal
[google-sre-slo]: https://sre.google/workbook/implementing-slos/
