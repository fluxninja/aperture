---
title: Flux Meter
sidebar_position: 6
keywords:
  - fluxmeter
  - histograms
---

:::info

See also [_Flux Meter_ reference][reference]

:::

The Flux Meter component provides a way to translate a flux of flows, matching a
[Selector][flow-selectors], into a Prometheus [histogram][histogram-metric]. It
also gathers metrics for the traffic that matches its selector. The histogram
created by Flux Meter measures the workload latency by default.

Example:

```yaml
flux_meters:
  cart-service1-app:
    selectors:
      - control_point: cart-service2-app
        label_matcher:
          match_labels:
            http.target: /service3
        service: kong-server.demoapp.svc.cluster.local
```

## Naming Convention

Each Flux Meter is identified by its unique name. It's strongly recommended
assigning globally unique names to Flux Meters. A good practice is to prefix the
Flux Meter name with the policy name. _Note that Flux Meters with repeated names
within the same [Agent Group](/concepts/selector.md#agent-group) will fail to
load at the agents._

## The Journey of a Request

The diagram details the journey of a request, as it traverses through the Flow
Selector forwards the request to the Flux Meter, which matches the request with
a Selector.

![Flux Meter](./assets/img/flux-meter-light.svg#gh-light-mode-only)
![Flux Meter](./assets/img/flux-meter-dark.svg#gh-dark-mode-only)

Post matching, the request is returned to the originating service for additional
processing. Subsequently, the service dispatches the request to the
OpenTelemetry pipeline. This pipeline's function is to report the data to
Prometheus for monitoring and alerting purposes.

This sophisticated workflow enables monitoring and helps in observing traffic
patterns effectively, establishing effective reliability strategies.

## Metric

The default metric tracked by _Flux Meter_ is the flow's workload duration in
milliseconds. The _Flux Meter_ might be configured to track any arbitrary metric
from OpenTelemetry attributes on log or span telemetry streams based on the
insertion method. For instance, any of the metrics defined in the Envoy [access
log specification][envoy-access-log-spec] might be used by _Flux Meter_.

## Buckets

The buckets used by histogram metric can be provided as configuration to _Flux
Meter_. Buckets effect the accuracy of [quantile][quantiles] calculations at
_Prometheus_ through [PromQL][promql-reference]. _Prometheus_ recommends
defining buckets close to the actual distribution of metric values to achieve
good accuracy.

:::note

Buckets are needed only for quantile queries, for example, getting the 95th
percentile of duration across pods in a service. The buckets do not matter if
you are only interested in the average duration or throughput metrics from a
_Flux Meter_.

:::

## Usage

_PromQL_ components can refer to the metrics generated by _Flux Meter_. The
histogram metric generated by _Flux Meter_ is named `flux_meter` and has the
following labels:

1. `flux_meter_name`: Name of the _Flux Meter_ metric
2. `decision_type`: Flow control decision from Agent
3. `status_code`: HTTP status code of the flow. Relevant only for traffic-based
   _Control Points_.
4. `flow_status`: Protocol independent status for the flow.
5. Other common labels available at all agents, such as `instance`.

:::info

For more details, please
[refer to metrics and labels](/reference/observability/prometheus-metrics/agent.md#flux-meter)
collected by _Flux Meters_.

:::

Query to get average duration (assuming default _Flux Meter_ metric):

```promql
sum(increase(flux_meter_sum{flux_meter_name=\"<name>\"}[10s]))/sum(increase(flux_meter_count{flux_meter_name=\"<name>\"}[10s]))
```

Query to get requests per second:

```promql
sum(rate(flux_meter_count{flux_meter_name=\"<name>\"}[10s]))
```

Query to get 95th percentile of duration:

```promql
histogram_quantile(0.95, sum(rate(flux_meter_bucket{flux_meter_name=\"<name>\"}[5m])) by (le))
```

[PromQL Components][promql-reference] in a Circuit can use the _Flux Meter_
metric in a PromQL query as described above. The PromQL Component generates a
[signal][signal] representing the results of the PromQL query.

### Control Loop

A control loop can use a duration signal generated using the _Flux Meter_ metric
as a signal to a Controller which determines the desired Concurrency of a
Service.

### Observability

_Flux Meters_ are a great way to measure [SLOs][google-sre-slo] of your Service
down to fine-grained APIs attributes such as endpoints, user types (subscriber
user compared to guest user).

[reference]: /reference/configuration/spec.md#flux-meter
[flow-selectors]: /concepts/selector.md
[histogram-metric]: https://prometheus.io/docs/practices/histograms/
[quantiles]: https://prometheus.io/docs/practices/histograms/#quantiles
[envoy-access-log-spec]:
  https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators
[promql-reference]: /reference/configuration/spec.md#prom-q-l
[signal]: /concepts/advanced/circuit.md#signal
[google-sre-slo]: https://sre.google/workbook/implementing-slos/
