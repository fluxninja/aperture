---
title: Per-user Rate Limiting
sidebar_position: 1
keywords:
  - guides
  - rate limiting
---

```mdx-code-block
import Zoom from 'react-medium-image-zoom';
import {apertureVersion} from '../apertureVersion.js';
import CodeBlock from '@theme/CodeBlock';
import Tabs from '@theme/Tabs';
import TabItem from "@theme/TabItem";
import {BashTab, TabContent} from './blueprintsComponents.js';
import CodeSnippet from '../codeSnippet.js'

```

## Overview

Rate limiting is a critical strategy for managing the load on an API. By
imposing restrictions on the number of requests a unique consumer can make
within a specific time frame, rate limiting prevents a small set of users from
monopolizing the majority of resources on a service, ensuring fair access for
all API consumers.

Aperture implements this strategy through its high-performance, distributed rate
limiter. This system enforces per-key limits based on fine-grained labels,
thereby offering precise control over API usage. For each unique key, Aperture
maintains a token bucket of a specified bucket capacity and fill rate. The fill
rate dictates the sustained requests per second (RPS) permitted for a key, while
transient overages over the fill rate are accommodated for brief periods, as
determined by the bucket capacity.

<Zoom>

```mermaid
{@include: ./assets/per-user-rate-limiting/rate-limiting.mmd}
```

</Zoom>

The diagram shows how the Aperture SDK interacts with a global token bucket to
determine whether to allow or reject a request. Each call decrements tokens from
the bucket and if the bucket runs out of tokens, indicating that the rate limit
has been reached, the incoming request is rejected. Conversely, if tokens are
available in the bucket, the request is accepted. The token bucket is
continually replenished at a predefined fill rate, up to the maximum number of
tokens specified by the bucket capacity.

:::note

The following policy is based on the
[Rate Limiting](/reference/blueprints/rate-limiting/base.md) blueprint.

:::

## Rate Limiting with Aperture SDK

The first step to use Aperture SDK is to import and set up Aperture Client:

```mdx-code-block
<Tabs>
<TabItem value="Typescript">
```

<CodeSnippet lang="ts" snippetName="clientConstructor" />

```mdx-code-block
  </TabItem>
</Tabs>
```

Start the flow with `StartFlow` by passing in a
[Control Point](/concepts/control-point.md) and
[labels](/concepts/flow-label.md) necessary to determine if a request should
proceed. The function `Flow.ShouldRun()` checks if the flow allows the request.
The `Flow.End()` function is responsible for sending telemetry, and updating the
specified cache entry within Aperture.

```mdx-code-block
<Tabs>
<TabItem value="TypeScript">
```

<CodeSnippet lang="ts" snippetName="handleRequestRateLimit" />

```mdx-code-block
  </TabItem>
</Tabs>
```

## Configuration

This policy is based on the
[Rate Limiting](/reference/blueprints/rate-limiting/base.md) blueprint. It
applies a rate limiter to the **`awesomeFeature`** and identifies unique users
by referencing the **`user_id`**.

Each user is allowed **`2`** requests every **`1s`** (1 second) period. A burst
of up to **`40`** requests is allowed. This means that the user can send up to
**`40`** requests in the first second, and then **`2`** requests every second
after that. The bucket gets replenished at the rate of **`2`** requests per
second (the fill rate).

The below `values.yaml` file can be generated by following the steps in the
[Installation](#installation) section.

```mdx-code-block
<Tabs>
<TabItem value="aperturectl values.yaml">
```

```yaml
{@include: ./assets/per-user-rate-limiting/values.yaml}
```

```mdx-code-block
</TabItem>
</Tabs>

```

<details><summary>Generated Policy</summary>
<p>

```yaml
{@include: ./assets/per-user-rate-limiting/policy.yaml}
```

</p>
</details>

:::info

[Circuit Diagram](./assets/per-user-rate-limiting/graph.mmd.svg) for this
policy.

:::

## Installation

Generate a values file specific to the policy. This can be achieved using the
command provided below.

```mdx-code-block
<CodeBlock language="bash">aperturectl blueprints values --name=rate-limiting/base --version={apertureVersion} --output-file=values.yaml</CodeBlock>
```

Apply the policy using the `aperturectl` CLI or `kubectl`.

```mdx-code-block
<Tabs>
  <TabItem value="aperturectl (Aperture Cloud)" label="aperturectl (Aperture Cloud)">
    <TabContent valuesFile="values" tabValue="aperturectl (Aperture Cloud)" />
  </TabItem>
</Tabs>
```

### Policy in Action

When the policy is applied at a service, no more than 2 requests per second
period (after an initial burst of 40 requests) are accepted for a user.

![Static Rate Limiting](./assets/per-user-rate-limiting/dashboard.png)
