---
title: Per-user Rate Limiting
sidebar_position: 2
keywords:
  - guides
  - rate limiting
---

```mdx-code-block
import Zoom from 'react-medium-image-zoom';
import {apertureVersion} from '../apertureVersion.js';
import CodeBlock from '@theme/CodeBlock';
import Tabs from '@theme/Tabs';
import {BashTab, TabContent} from './blueprintsComponents.js';
```

## Overview

Rate limiting is a critical strategy for managing the load on an API. By
imposing restrictions on the number of requests a unique consumer can make
within a specific time frame, rate limiting prevents a small set of users from
monopolizing the majority of resources on a service, ensuring fair access for
all API consumers.

Aperture implements this strategy through its high-performance, distributed rate
limiter. This system enforces per-key limits based on fine-grained labels,
thereby offering precise control over API usage. For each unique key, Aperture
maintains a token bucket of a specified bucket capacity and fill rate. The fill
rate dictates the sustained requests per second (RPS) permitted for a key, while
transient overages over the fill rate are accommodated for brief periods, as
determined by the bucket capacity.

This intricate system of rate-limiting plays a pivotal role in maintaining the
integrity of a service. It effectively safeguards against excessive usage that
could potentially result in API abuse, while simultaneously ensuring optimal
performance and resource allocation.

<Zoom>

```mermaid
{@include: ./assets/per-user-rate-limiting/rate-limiting.mmd}
```

</Zoom>

The diagram depicts the distribution of tokens across Agents through a global
token bucket. Each incoming request prompts the Agents to decrement tokens from
the bucket. If the bucket has run out of tokens, indicating that the rate limit
has been reached, the incoming request is rejected. Conversely, if tokens are
available in the bucket, the request is accepted. The token bucket is
continually replenished at a predefined fill rate, up to the maximum number of
tokens specified by the bucket capacity.

:::note

The following policy is based on the
[Rate Limiting](/reference/blueprints/rate-limiting/base.md) blueprint.

:::

## Configuration

This policy is based on the
[Rate Limiting](/reference/blueprints/rate-limiting/base.md) blueprint. It
applies a rate limiter to the **`ingress`** control point on the service
**`catalog-service.prod.svc.cluster.local`** and identifies unique users by
referencing the **`user_id`** header present in the HTTP traffic. Provided by
the Envoy proxy, this header can be located under the label key
**`http.request.header.user_id`** (see [Flow Labels](/concepts/flow-label.md)
for more information).

Each user is allowed **`2`** requests every **`1s`** (1 second) period. A burst
of up to **`40`** requests is allowed. This means that the user can send up to
**`40`** requests in the first second, and then **`2`** requests every second
after that. The bucket gets replenished at the rate of **`2`** requests per
second (the fill rate).

The below `values.yaml` file can be generated by following the steps in the
[Installation](#installation) section.

```mdx-code-block
<Tabs>
<TabItem value="aperturectl values.yaml">
```

```yaml
{@include: ./assets/per-user-rate-limiting/values.yaml}
```

```mdx-code-block
</TabItem>
</Tabs>

```

<details><summary>Generated Policy</summary>
<p>

```yaml
{@include: ./assets/per-user-rate-limiting/policy.yaml}
```

</p>
</details>

:::info

[Circuit Diagram](./assets/per-user-rate-limiting/graph.mmd.svg) for this
policy.

:::

## Installation

Generate a values file specific to the policy. This can be achieved using the
command provided below.

```mdx-code-block
<CodeBlock language="bash">aperturectl blueprints values --name=rate-limiting/base --version={apertureVersion} --output-file=values.yaml</CodeBlock>
```

Apply the policy using the `aperturectl` CLI or `kubectl`.

```mdx-code-block
<Tabs>
  <TabItem value="aperturectl (Aperture Cloud)" label="aperturectl (Aperture Cloud)">
    <TabContent valuesFile="values" tabValue="aperturectl (Aperture Cloud)" />
  </TabItem>
  <TabItem value="aperturectl (self-hosted controller)" label="aperturectl (self-hosted controller)">
```

Pass the `--kube` flag with `aperturectl` to directly apply the generated policy
on a Kubernetes cluster in the namespace where the Aperture Controller is
installed.

```mdx-code-block
  <TabContent valuesFile="values" tabValue="aperturectl (self-hosted controller)" policyName="static-rate-limiting" />
</TabItem>
<TabItem value="kubectl (self-hosted controller)" label="kubectl (self-hosted controller)">
```

Apply the generated policy YAML (Kubernetes Custom Resource) with `kubectl`.

```mdx-code-block
  <TabContent valuesFile="values" tabValue="kubectl (self-hosted controller)" policyName="static-rate-limiting" />
</TabItem>

</Tabs>
```

### Policy in Action

When the policy is applied at a service, no more than 2 requests per second
period (after an initial burst of 40 requests) are accepted for a user.

![Static Rate Limiting](./assets/per-user-rate-limiting/dashboard.png)
