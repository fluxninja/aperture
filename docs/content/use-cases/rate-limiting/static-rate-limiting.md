---
title: Static Rate Limiting
keywords:
  - policies
  - ratelimit
sidebar_position: 1
---

```mdx-code-block
import {apertureVersion} from '../../apertureVersion.js';
import CodeBlock from '@theme/CodeBlock';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import Zoom from 'react-medium-image-zoom';
```

## Overview

When exposing an API to the public, it is critical to protect it from potential
abuse by heavy hitters and malicious users. This ensures that the API remains
available and performs optimally for all users. Aperture's rate limiter
identifies users in the traffic using labels in the request. Distributed token
buckets are maintained for each user, ensuring that each user stays within the
assigned limits. The token bucket is configured with a fill rate that determines
the maximum request rate in steady state. The bucket's capacity determines the
magnitude of momentary surge allowed in request rates.

## Configuration

This policy is based on the
[Rate Limiting](/reference/blueprints/rate-limiting/base.md) blueprint. It
applies a rate limiter to the **`ingress`** control point on the service
**`catalog-service.prod.svc.cluster.local`** and identifies unique users by
referencing the **`user_id`** header present in the HTTP traffic. Provided by
the Envoy proxy, this header can be located under the label key
**`http.request.header.user_id`** (see [Flow Labels](/concepts/flow-label.md)
for more information).

Each user is allowed **`2`** requests every **`1s`** (1 second) period. A burst
of up to **`40`** requests is allowed. This means that the user can send up to
**`40`** requests in the first second, and then **`2`** requests every second
after that. The bucket gets replenished at the rate of **`2`** requests per
second (the fill rate).

The below `values.yaml` file can be generated by following the steps in the
[Installation](#installation) section.

```mdx-code-block
<Tabs>
<TabItem value="aperturectl values.yaml">
```

```yaml
{@include: ./assets/static-rate-limiting/values.yaml}
```

```mdx-code-block
</TabItem>
</Tabs>

```

<details><summary>Generated Policy</summary>
<p>

```yaml
{@include: ./assets/static-rate-limiting/policy.yaml}
```

</p>
</details>

:::info

[Circuit Diagram](./assets/static-rate-limiting/graph.mmd.svg) for this policy.

:::

## Installation

Generate a values file specific to the policy. This can be achieved using the
command provided below.

```mdx-code-block
<CodeBlock language="bash">aperturectl blueprints values --name=rate-limiting/base --version={apertureVersion} --output-file=values.yaml</CodeBlock>
```

Adjust the values to match the application requirements. Use the following
command to generate the policy.

```mdx-code-block
<CodeBlock language="bash">aperturectl blueprints generate --name=rate-limiting/base
--values-file=values.yaml --output-dir=policy-gen --version={apertureVersion}</CodeBlock>
```

Apply the policy using the `aperturectl` CLI or `kubectl`.

```mdx-code-block
<Tabs>
<TabItem value="aperturectl" label="aperturectl">
```

Pass the `--kube` flag with `aperturectl` to directly apply the generated policy
on a Kubernetes cluster in the namespace where the Aperture Controller is
installed.

```mdx-code-block
<CodeBlock language="bash">aperturectl apply policy --file=policy-gen/policies/rate-limiting.yaml --kube </CodeBlock>
```

```mdx-code-block
</TabItem>
<TabItem value="kubectl" label="kubectl">
```

Apply the policy YAML generated (Kubernetes Custom Resource) using the above
example with `kubectl`.

```bash
kubectl apply -f policy-gen/configuration/rate-limiting-cr.yaml -n aperture-controller
```

```mdx-code-block
</TabItem>
</Tabs>
```

### Policy in Action

When the policy is applied at a service, no more than 2 requests per second
period (after an initial burst of 40 requests) are accepted for a user.

<Zoom>

![Static Rate Limiting](./assets/static-rate-limiting/dashboard.png)

</Zoom>
