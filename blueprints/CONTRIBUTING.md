# Blueprints Layout

Every blueprint consists of three files: `bundle.libsonnet` `config.libsonnet`
and `metadata.yaml`

## metadata.yaml

This file specifies some metadata about the blueprint that is current used to
auto generate README.md configuration section.

An example metadata looks like this:

```yaml
blueprint: Latency AIMD Concurrency Limiting Policy
sources:
  policy: service-protection/average-latency/policy.libsonnet
deprecation_message: |
  This blueprint is deprecated and will be removed in the future.
  Please use the `load-scheduling/average-latency` blueprint instead.
```

- `blueprint` key is currently unused, but it names this specific bundle
- `sources` provides a list of policies that are part of this blueprint.
- `deprecation_message` is an optional message that will be displayed in the
  generated README.md. It can be used to mark blueprints as deprecated.

### More on sources

Every blueprint can be built from multiple policies, and to properly generate
README.md we need to know some details about what source libraries are used.

Every item of the `sources` list is a nested object, whose top key becomes a
section of the README.md documentation. `prefix` should match the key under
which policy configuration is available in `config.libsonnet` and `path` is a
path to the library, relative to repository root.

## bundle.libsonnet

An example:

```yaml
local blueprint = import './rate-limiting.libsonnet';

local policy = blueprint.policy;
local config = blueprint.config;

function(params) {
  local c = std.mergePatch(config, params),

  local p = policy(c),
  policies: {
    [std.format('%s-cr.yaml', c.policy.policy_name)]: p.policyResource,
    [std.format('%s.yaml', c.policy.policy_name)]: p.policyDef,
  },
}
```

This file glues together all policies that are part of the blueprint. The object
must have key: `policies` - other keys should be hidden from the generated JSON
data. The key should be mappings between file names and rendered policies.

This is used by `blueprint-assets-generator.py` to values and definition files
directly from blueprints.

## config.libsonnet

An example (partial):

```jsonnet
{
  /**
  * @section Latency AIMD Concurrency Limiting Policy
  *
  * @param (policy.policy_name: string required) A name of the policy, used within PromQL queries for fluxmeter metrics.
  * @param (policy.evaluation_interval: string) How often should policy be re-evaluated.
  */
  policy: {
    policy_name: error 'policyName is not set',
    evaluation_interval: '0.5s',
  }
}
```

`config.libsonnet` provides configuration for the blueprint that has two uses:

- a reference for the user
- source of configuration reference for README.md

This file must be kept in sync with libraries - when adding new defaults to
libraries, all blueprints should be updated to match them.

### Configuration Reference

Configuration reference can be autogenerated from config.libsonnet based on
docblock comments.

Parser knows about the following docblock tags: `@section`, `@subsection` and
`@param`.

`@section` tag is used to match docblock to the README.md configuration section
(See [More on sources][more on sources] from `metadata.yaml` description). This
field is required.

`@subsection` must be unique within single `@section` and it is used to separate
parts of the configuration reference with sub headings.

`@param` can be used to add documentation for specific fields. It's format is as
follow:

```
@param (documented.key: type <optional required>) Documentation
```

`documented.key` must be a full path to the key that is being documented. `type`
is not validated but should be one of:

- string
- number
- boolean
- aperture libsonnet type (e.g. `[]aperture.spec.v1.SchedulerWorkload`)

It's not used for anything else currently, but keeping it consistent is a win
for users.

`<optional required>` is an optional `required` string that marks given variable
as required. Required variables are marked as `(required)` in the Default column
of the generated README.md.

# Updating README.md

README.md generator depends on Python 3.8+ and some extra libraries that can be
installed from `requirements.txt`:

```sh
pip install -r requirements.txt
```

To update README.md from blueprint configuration, use
`blueprint-assets-generator.py`:

```sh
$ ./scripts/blueprint-assets-generator.py policies/service-protection/average-latency
$
```

It will take the existing README.md, look for a configuration marker:
`[configuration]: # Configuration` and replace existing generated docs with new
content.

## Blueprint Visualization

Blueprints can be visualized. A blueprint is saved as a
[DOT](https://graphviz.org/doc/info/lang.html) file and then can be converted
into an image with GraphViz:

```sh
aperturectl compile --cr blueprints/examples/service-protection/average-latency/gen/policies/example.yaml --dot blueprints/examples/service-protection/average-latency/gen/graph/graph.dot
dot -Tsvg  blueprints/examples/service-protection/average-latency/gen/graph/graph.dot > blueprints/examples/service-protection/average-latency/gen/graph/graph.svg
```

Before doing so make sure that generated yamls are up-to-date.

You can now view visualized blueprint.
