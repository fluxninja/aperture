{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "title": "policies/service-protection/average-latency blueprint",
  "additionalProperties": false,
  "required": ["policy"],
  "properties": {
    "policy": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "policy_name",
        "service_protection_core",
        "latency_baseliner"
      ],
      "properties": {
        "policy_name": {
          "description": "Name of the policy.",
          "default": "__REQUIRED_FIELD__",
          "type": "string"
        },
        "components": {
          "description": "List of additional circuit components.",
          "default": [],
          "type": "array",
          "items": {
            "type": "object",
            "$ref": "../../../../gen/jsonschema/_definitions.json#/definitions/Component"
          }
        },
        "resources": {
          "description": "Additional resources.",
          "default": {
            "flow_control": {
              "classifiers": []
            }
          },
          "type": "object",
          "$ref": "../../../../gen/jsonschema/_definitions.json#/definitions/Resources"
        },
        "evaluation_interval": {
          "description": "The interval between successive evaluations of the Circuit.",
          "default": "10s",
          "type": "string"
        },
        "service_protection_core": {
          "type": "object",
          "additionalProperties": false,
          "required": ["adaptive_load_scheduler"],
          "properties": {
            "overload_confirmations": {
              "description": "List of overload confirmation criteria. Load scheduler can throttle flows when all of the specified overload confirmation criteria are met.",
              "default": [],
              "type": "array",
              "items": {
                "type": "object",
                "$ref": "#/$defs/overload_confirmation"
              }
            },
            "adaptive_load_scheduler": {
              "description": "Parameters for Adaptive Load Scheduler.",
              "default": {
                "alerter": {
                  "alert_name": "Load Throttling Event"
                },
                "gradient": {
                  "max_gradient": 1,
                  "min_gradient": 0.1,
                  "slope": -1
                },
                "load_multiplier_linear_increment": 0.025,
                "load_scheduler": {
                  "selectors": [
                    {
                      "control_point": "__REQUIRED_FIELD__",
                      "service": "__REQUIRED_FIELD__"
                    }
                  ]
                },
                "max_load_multiplier": 2
              },
              "type": "object",
              "$ref": "../../../../gen/jsonschema/_definitions.json#/definitions/AdaptiveLoadSchedulerParameters"
            },
            "dry_run": {
              "description": "Default configuration for setting dry run mode on Load Scheduler. In dry run mode, the Load Scheduler acts as a passthrough and does not throttle flows. This config can be updated at runtime without restarting the policy.",
              "default": false,
              "type": "boolean"
            }
          }
        },
        "auto_scaling": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "dry_run": {
              "description": "Dry run mode ensures that no scaling is invoked by the auto scaler escalation. This config can be updated at runtime without restarting the policy.",
              "default": false,
              "type": "boolean"
            },
            "promql_scale_out_controllers": {
              "description": "List of scale out controllers.",
              "default": [],
              "type": "array",
              "items": {
                "type": "object",
                "$ref": "#/$defs/promql_scale_out_controller"
              }
            },
            "promql_scale_in_controllers": {
              "description": "List of scale in controllers.",
              "default": [],
              "type": "array",
              "items": {
                "type": "object",
                "$ref": "#/$defs/promql_scale_in_controller"
              }
            },
            "scaling_parameters": {
              "description": "Parameters that define the scaling behavior.",
              "default": {
                "scale_in_alerter": {
                  "alert_name": "Auto-scaler is scaling in"
                },
                "scale_in_cooldown": "40s",
                "scale_out_alerter": {
                  "alert_name": "Auto-scaler is scaling out"
                },
                "scale_out_cooldown": "30s"
              },
              "type": "object",
              "$ref": "../../../../gen/jsonschema/_definitions.json#/definitions/AutoScalerScalingParameters"
            },
            "scaling_backend": {
              "description": "Scaling backend for the policy.",
              "default": {
                "kubernetes_replicas": {
                  "kubernetes_object_selector": "__REQUIRED_FIELD__",
                  "max_replicas": "__REQUIRED_FIELD__",
                  "min_replicas": "__REQUIRED_FIELD__"
                }
              },
              "type": "object",
              "$ref": "../../../../gen/jsonschema/_definitions.json#/definitions/AutoScalerScalingBackend"
            },
            "periodic_decrease": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "period": {
                  "description": "Period for periodic scale in.",
                  "default": "60s",
                  "type": "string"
                },
                "scale_in_percentage": {
                  "description": "Percentage of replicas to scale in.",
                  "default": 10,
                  "type": "number",
                  "format": "double"
                }
              }
            }
          }
        },
        "latency_baseliner": {
          "type": "object",
          "additionalProperties": false,
          "required": ["flux_meter"],
          "properties": {
            "flux_meter": {
              "description": "Flux Meter defines the scope of latency measurements.",
              "default": {
                "selectors": [
                  {
                    "control_point": "__REQUIRED_FIELD__",
                    "service": "__REQUIRED_FIELD__"
                  }
                ]
              },
              "type": "object",
              "$ref": "../../../../gen/jsonschema/_definitions.json#/definitions/FluxMeter"
            },
            "ema": {
              "description": "EMA parameters.",
              "default": {
                "correction_factor_on_max_envelope_violation": 0.95,
                "ema_window": "1500s",
                "warmup_window": "60s"
              },
              "type": "object",
              "$ref": "../../../../gen/jsonschema/_definitions.json#/definitions/EMAParameters"
            },
            "latency_tolerance_multiplier": {
              "description": "Tolerance factor beyond which the service is considered to be in overloaded state. E.g. if EMA of latency is 50ms and if Tolerance is 1.1, then service is considered to be in overloaded state if current latency is more than 55ms.",
              "default": "__REQUIRED_FIELD__",
              "type": "number",
              "format": "double"
            },
            "latency_ema_limit_multiplier": {
              "description": "Current latency value is multiplied with this factor to calculate maximum envelope of Latency EMA.",
              "default": 2,
              "type": "number",
              "format": "double"
            }
          }
        }
      }
    },
    "dashboard": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "refresh_interval": {
          "description": "Refresh interval for dashboard panels.",
          "default": "15s",
          "type": "string"
        },
        "time_from": {
          "description": "Time from of dashboard.",
          "default": "now-15m",
          "type": "string"
        },
        "time_to": {
          "description": "Time to of dashboard.",
          "default": "now",
          "type": "string"
        },
        "extra_filters": {
          "description": "Additional filters to pass to each query to Grafana datasource.",
          "default": {},
          "type": "object",
          "additionalProperties": true
        },
        "title": {
          "description": "Name of the main dashboard.",
          "default": "Aperture Service Protection",
          "type": "string"
        },
        "datasource": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "name": {
              "description": "Datasource name.",
              "default": "$datasource",
              "type": "string"
            },
            "filter_regex": {
              "description": "Datasource filter regex.",
              "default": "",
              "type": "string"
            }
          }
        }
      }
    }
  },
  "$defs": {
    "overload_confirmation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["query_string"],
      "properties": {
        "query_string": {
          "description": "The Prometheus query to be run. Must return a scalar or a vector with a single element.",
          "type": "string"
        },
        "threshold": {
          "description": "The threshold for the overload confirmation criteria.",
          "type": "number",
          "format": "double"
        },
        "operator": {
          "description": "The operator for the overload confirmation criteria. oneof: `gt | lt | gte | lte | eq | neq`",
          "type": "string"
        }
      }
    },
    "promql_scale_out_controller": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "query_string": {
          "description": "The Prometheus query to be run. Must return a scalar or a vector with a single element.",
          "type": "string"
        },
        "threshold": {
          "description": "Threshold for the controller.",
          "type": "number",
          "format": "double"
        },
        "gradient": {
          "description": "Gradient parameters for the controller.",
          "type": "object",
          "$ref": "../../../../gen/jsonschema/_definitions.json#/definitions/IncreasingGradientParameters"
        },
        "alerter": {
          "description": "Alerter parameters for the controller.",
          "type": "object",
          "$ref": "../../../../gen/jsonschema/_definitions.json#/definitions/AlerterParameters"
        }
      }
    },
    "promql_scale_in_controller": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "query_string": {
          "description": "The Prometheus query to be run. Must return a scalar or a vector with a single element.",
          "type": "string"
        },
        "threshold": {
          "description": "Threshold for the controller.",
          "type": "number",
          "format": "double"
        },
        "gradient": {
          "description": "Gradient parameters for the controller.",
          "type": "object",
          "$ref": "../../../../gen/jsonschema/_definitions.json#/definitions/DecreasingGradientParameters"
        },
        "alerter": {
          "description": "Alerter parameters for the controller.",
          "type": "object",
          "$ref": "../../../../gen/jsonschema/_definitions.json#/definitions/AlerterParameters"
        }
      }
    }
  }
}
