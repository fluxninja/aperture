apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: agent-cm-validator
  namespace: {{ template "common.names.namespace" . }}
webhooks:
  - name: cm-validator.fluxninja.com
    clientConfig:
      service:
        name: agent-webhooks
        namespace: {{ template "common.names.namespace" . }}
        path: "/validate/configmap"
      caBundle: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNvVENDQVlrQ0ZCZ1FIK0Z1bHlKMUtDanJkTng5dGpvT2g3YmlNQTBHQ1NxR1NJYjNEUUVCRFFVQU1BMHgKQ3pBSkJnTlZCQVlUQWxWVE1CNFhEVEl5TURNd09URXdNak13TWxvWERUTXlNRE13TmpFd01qTXdNbG93RFRFTApNQWtHQTFVRUJoTUNWVk13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLQW9JQkFRQzlrTlFRCmJOYVpSQ1VDN0o3OEExNE1ibjk3SlZ5akpDOWhyem10ZzAreGNmUVVRS01WMkM5c0E4anJobGVvRm1uaVJQcnUKeTVMbkp2di9ieG1RUVcxQWFQam5zUG9sNFlBdFpOUkNGODhNWnplNm4rL3JIS1R6Y3pIbXdoTXlSQ0RXbXhkWgpoSGpEakphWE92SXF0Q08xTWNidi9pZGkwQjQ2UEVxM1dSSlBISTNLZzI4eENKaDNZemJ4YW91SGVoMHJoYkxhCk5QM1pkZFJqc1JleHBTNUJ2LzQ4bWV3VENYQWdNc2ZlYTZrRTUxcWplQm1nOU5iMDJJempubHVZNXRPRUpoREYKUW5vczJoMkVkT0lFbWVaVEtuL0E3dDE3emNNZk4ybzNBQXNXclU4WXZFakFvakZwVmR2RnFyRUZzVWJPUXZzcgo1dGc4OEJ4Nmtjc1dqRFVaQWdNQkFBRXdEUVlKS29aSWh2Y05BUUVOQlFBRGdnRUJBSlZEdzRSTTVGenJKR1F5Cmk3ekNRTm1JVFJ2WFBjTlNISXVacXo5Z0l3ejNpRXJtdnFMbEVDblFhaDNnUzJ0ckF0VVh1T01NN1RVLzVvVlQKSVhZeS91d0pRNVZjNDVQZnQ3NjRGQmlySVF6MzlCVURPbm1VNHRkSDA1WnRwQ0pqM1BDYW9Wb05vSGZob3JkTgoyKzBFYVBkM3h1OENxZWlybnVlbmxRUWl5UFRYbVUvb3pnTENJRnV0OER5dURycjhDZDAzd2o4R3lpdHFUYjBpClZWbTJJU2dOc2dORlNlaEpobmFoWEw1VU1MK3JHZVdKYnM1MGc5ZzNEdVdia01IMEpvUisxTU5tVDJrM0pWbEYKaC9PeWhhemVsbGFnWHQvT0lBUnVlTndHdUZUazlOTTlxWDg2MUdiU1FiYzM4Z2hYNjkrMExxWVdnRUp2ZUJHZwprRndEbDhBPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==" # agent-cm-validator
    # Assuming the FN-system will have a "name" label set
    namespaceSelector:
      matchLabels:
        "kubernetes.io/metadata.name": {{ template "common.names.namespace" . }}
    objectSelector:
      matchLabels:
        "fluxninja.com/validate": "true"
    rules:
      - operations: ["CREATE", "UPDATE"]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["configmaps"]
        scope: Namespaced
    admissionReviewVersions: ["v1"]
    failurePolicy: Fail
    sideEffects: None
    timeoutSeconds: 5
