{{- if .Values.agent.create }}
apiVersion: fluxninja.com/v1alpha1
kind: Agent
metadata:
  name: {{ .Release.Name }}
  namespace: {{ template "common.names.namespace" . }}
  labels: {{- include "common.labels.standard" . | nindent 4 }}
    app.kubernetes.io/component: aperture-agent-manager
    {{- if .Values.commonLabels }}
    {{- include "common.tplvalues.render" ( dict "value" .Values.commonLabels "context" $ ) | nindent 4 }}
    {{- end }}
  {{- if .Values.commonAnnotations }}
  annotations:
    {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 4 }}
  {{- end }}
spec:
  {{- if or .Values.agent.image.registry .Values.agent.image.repository .Values.agent.image.tag .Values.agent.image.pullPolicy .Values.agent.image.pullSecrets }}
  image: {{ .Values.agent.image | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.service.annotations }}
  service:
    annotations: {{ .Values.agent.service.annotations }}
  {{- end }}
  serviceAccount:
    create: {{ .Values.agent.serviceAccount.create }}
    {{- if .Values.agent.serviceAccount.annotations }}
    annotations: {{ .Values.agent.serviceAccount.annotations | toYaml | indent 6 }}
    {{- end }}
    {{- if .Values.agent.serviceAccount.automountServiceAccountToken }}
    automountServiceAccountToken: {{ .Values.agent.serviceAccount.automountServiceAccountToken }}
    {{- end }}
  livenessProbe:
    enabled: {{ .Values.agent.livenessProbe.enabled }}
    {{- if  .Values.agent.livenessProbe.initialDelaySeconds }}
    initialDelaySeconds: {{ .Values.agent.livenessProbe.initialDelaySeconds }}
    {{- end }}
    {{- if  .Values.agent.livenessProbe.periodSeconds }}
    periodSeconds: {{ .Values.agent.livenessProbe.periodSeconds }}
    {{- end }}
    {{- if  .Values.agent.livenessProbe.timeoutSeconds }}
    timeoutSeconds: {{ .Values.agent.livenessProbe.timeoutSeconds }}
    {{- end }}
    {{- if  .Values.agent.livenessProbe.failureThreshold }}
    failureThreshold: {{ .Values.agent.livenessProbe.failureThreshold }}
    {{- end }}
    {{- if  .Values.agent.livenessProbe.successThreshold }}
    successThreshold: {{ .Values.agent.livenessProbe.successThreshold }}
    {{- end }}
  readinessProbe:
    enabled: {{ .Values.agent.readinessProbe.enabled }}
    {{- if  .Values.agent.livenessProbe.initialDelaySeconds }}
    initialDelaySeconds: {{ .Values.agent.readinessProbe.initialDelaySeconds }}
    {{- end }}
    {{- if  .Values.agent.livenessProbe.periodSeconds }}
    periodSeconds: {{ .Values.agent.readinessProbe.periodSeconds }}
    {{- end }}
    {{- if  .Values.agent.livenessProbe.timeoutSeconds }}
    timeoutSeconds: {{ .Values.agent.readinessProbe.timeoutSeconds }}
    {{- end }}
    {{- if  .Values.agent.livenessProbe.failureThreshold }}
    failureThreshold: {{ .Values.agent.readinessProbe.failureThreshold }}
    {{- end }}
    {{- if  .Values.agent.livenessProbe.successThreshold }}
    successThreshold: {{ .Values.agent.readinessProbe.successThreshold }}
    {{- end }}
  {{- if .Values.agent.customLivenessProbe }}
  customLivenessProbe: {{ .Values.agent.customLivenessProbe | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.customReadinessProbe }}
  customReadinessProbe: {{ .Values.agent.customReadinessProbe | toYaml | nindent 4 }}
  {{- end }}
  {{- if or .Values.agent.resources.limits .Values.agent.resources.requests }}
  resources: {{ .Values.agent.resources | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.podSecurityContext.enabled }}
  podSecurityContext: {{- .Values.agent.podSecurityContext | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.podSecurityContext.enabled }}
  containerSecurityContext: {{- .Values.agent.containerSecurityContext | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.command }}
  command: {{ .Values.agent.command | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.args }}
  args: {{ .Values.agent.args | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.podLabels }}
  podLabels: {{ .Values.agent.podLabels | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.podAnnotations }}
  podAnnotations: {{ .Values.agent.podAnnotations | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.affinity }}
  affinity: {{ .Values.agent.affinity | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.nodeSelector }}
  nodeSelector: {{ .Values.agent.nodeSelector | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.tolerations }}
  tolerations: {{ .Values.agent.tolerations | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.terminationGracePeriodSeconds }}
  terminationGracePeriodSeconds: {{ .Values.agent.terminationGracePeriodSeconds | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.lifecycleHooks }}
  lifecycleHooks: {{ .Values.agent.lifecycleHooks | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.extraEnvVars }}
  extraEnvVars: {{ .Values.agent.extraEnvVars | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.extraVolumes }}
  extraVolumes: {{ .Values.agent.extraVolumes | toYaml | nindent 4}}
  {{- end }}
  {{- if .Values.agent.extraVolumeMounts }}
  extraVolumeMounts: {{ .Values.agent.extraVolumeMounts | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.sidecars }}
  sidecars: {{ .Values.agent.sidecars | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.agent.initContainers }}
  initContainers: {{ .Values.agent.initContainers | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.commonLabels }}
  labels: {{ .Values.commonLabels | toYaml | nindent 4 }}
  {{- end }}
  {{- if .Values.commonAnnotations }}
  annotations: {{ .Values.commonAnnotations | toYaml | nindent 4 }}
  {{- end }}
  {{- if and .Values.agent.secrets .Values.agent.secrets.fluxninjaPlugin .Values.agent.secrets.fluxninjaPlugin .Values.agent.secrets.fluxninjaPlugin.create }}
  secrets:
    fluxninjaPlugin:
      apiKeySecret:
      {{- if .Values.agent.secrets.fluxninjaPlugin.create }}
      create: {{ .Values.agent.secrets.fluxninjaPlugin.create }}
      {{- end }}
      {{- if or .Values.agent.secrets.fluxninjaPlugin.secretKeyRef.name .Values.agent.secrets.fluxninjaPlugin.secretKeyRef.key }}
      secretKeyRef:
        {{- if .Values.agent.secrets.fluxninjaPlugin.secretKeyRef.name }}
        name: {{ .Values.agent.secrets.fluxninjaPlugin.secretKeyRef.name }}
        {{- end }}
        {{- if .Values.agent.secrets.fluxninjaPlugin.secretKeyRef.key }}
        key: {{ .Values.agent.secrets.fluxninjaPlugin.secretKeyRef.key }}
        {{- end }}
      {{- end }}
      value: {{ include "agent.apisecret.value" ( dict "agent" .Values.agent $) }}
  {{- end }}
  {{- if .Values.agent.sidecar.enabled }}
  sidecar:
    enabled: {{ .Values.agent.sidecar.enabled }}
    {{- if .Values.agent.sidecar.enableNamespacesByDefault }}
    enableNamespacesByDefault: {{ .Values.agent.sidecar.enableNamespacesByDefault }}
    {{- end }}
  {{- end }}
  config:
    {{- if and .Values.agent.config.fluxninja_plugin .Values.agent.config.fluxninja_plugin.enabled }}
    fluxninja_plugin:
      fluxninja_endpoint: {{ include "agent.fluxninjaPlugin.endpoint" ( dict "agent" .Values.agent $) }}
      {{- if .Values.agent.config.fluxninja_plugin.heartbeat_interval }}
      heartbeat_interval: {{ .Values.agent.config.fluxninja_plugin.heartbeat_interval }}
      {{- end }}
      {{- if .Values.agent.config.fluxninja_plugin.client_grpc }}
      client_grpc:
        {{- if .Values.agent.config.fluxninja_plugin.client_grpc }}
        insecure: {{ .Values.agent.config.fluxninja_plugin.client_grpc.insecure }}
        {{- end }}
        {{- if .Values.agent.config.fluxninja_plugin.client_grpc.tls }}
        tls:
          {{- if .Values.agent.config.fluxninja_plugin.client_grpc.tls.insecure_skip_verify }}
          insecure_skip_verify: {{ .Values.agent.config.fluxninja_plugin.client_grpc.tls.insecure_skip_verify }}
          {{- end }}
          {{- if .Values.agent.config.fluxninja_plugin.client_grpc.tls.ca_file }}
          ca_file: {{ .Values.agent.config.fluxninja_plugin.client_grpc.tls.ca_file }}
          {{- end }}
        {{- end }}
      {{- end }}
      {{- if .Values.agent.config.fluxninja_plugin.client_http }}
      client_http:
        {{- if .Values.agent.config.fluxninja_plugin.client_http.tls }}
        tls:
          {{- if .Values.agent.config.fluxninja_plugin.client_http.tls.insecure_skip_verify }}
          insecure_skip_verify: {{ .Values.agent.config.fluxninja_plugin.client_http.tls.insecure_skip_verify }}
          {{- end }}
          {{- if .Values.agent.config.fluxninja_plugin.client_http.tls.ca_file }}
          ca_file: {{ .Values.agent.config.fluxninja_plugin.client_http.tls.ca_file }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
    plugins:
      disable_plugins: false
      {{- if and .Values.agent.config.fluxninja_plugin (not .Values.agent.config.fluxninja_plugin.enabled) }}
      disabled_plugins:
      - aperture-plugin-fluxninja
      {{- end }}
    etcd:  {{- omit .Values.agent.config.etcd "endpoints" | toYaml | nindent 6 }}
      endpoints: {{ include "agent.etcd.endpoints" (dict "etcd" .Values.agent.config.etcd "context" . $) }}
    prometheus:
      address: {{ include "agent.prometheus.address" (dict "prometheus" .Values.agent.config.prometheus "context" . $) }}
    {{- if .Values.agent.config.server }}
    server:
      {{- if .Values.agent.config.server.addr }}
      addr: {{ .Values.agent.config.server.addr }}
      {{- end }}
    {{- end }}
    {{- if .Values.agent.config.dist_cache }}
    dist_cache:
      {{- if .Values.agent.config.dist_cache.bind_addr }}
      bind_addr: {{ .Values.agent.config.dist_cache.bind_addr }}
      {{- end }}
      {{- if .Values.agent.config.dist_cache.memberlist_bind_addr }}
      memberlist_bind_addr: {{ .Values.agent.config.dist_cache.memberlist_bind_addr }}
      {{- end }}
    {{- end }}
    {{- if .Values.agent.config.log }}
    log: {{ .Values.agent.config.log | toYaml | nindent 6 }}
    {{- end }}
    {{- if .Values.agent.config.agent_info }}
    agent_info:
      {{- if .Values.agent.config.agent_info.agent_group }}
      agent_group: {{ .Values.agent.config.agent_info.agent_group }}
      {{- end }}
    {{- end }}
    {{- if or .Values.agent.config.otel }}
    otel:
      {{- if .Values.agent.config.otel.grpc_addr }}
      grpc_addr: {{ .Values.agent.config.otel.grpc_addr }}
      {{- end }}
      {{- if .Values.agent.config.otel.http_addr }}
      http_addr: {{ .Values.agent.config.otel.http_addr }}
      {{- end }}
      {{- if or .Values.agent.config.otel.batch_prerollup }}
      batch_prerollup:
        {{- if .Values.agent.config.otel.batch_prerollup.send_batch_size }}
        send_batch_size: {{ .Values.agent.config.otel.batch_prerollup.send_batch_size }}
        {{- end }}
        {{- if .Values.agent.config.otel.batch_prerollup.timeout }}
        timeout: {{ .Values.agent.config.otel.batch_prerollup.timeout }}
        {{- end }}
      {{- end }}
      {{- if or .Values.agent.config.otel.batch_postrollup }}
      batch_postrollup:
        {{- if .Values.agent.config.otel.batch_postrollup.send_batch_size }}
        send_batch_size: {{ .Values.agent.config.otel.batch_postrollup.send_batch_size }}
        {{- end }}
        {{- if .Values.agent.config.otel.batch_postrollup.timeout }}
        timeout: {{ .Values.agent.config.otel.batch_postrollup.timeout }}
        {{- end }}
      {{- end }}
    {{- end }}
{{- end }}
