version: 2.1

workflows:
  version: 2

  release-components:
    when:
      # Ignore agent releases and handle them separately
      matches: { value: << pipeline.git.tag >>, pattern: "^releases/(?!aperture-agent).*$" }
    jobs:
      - release-components:
          # both this and workflow's when is needed
          filters:
            branches:
              ignore: /.+/
            tags:
              only: /^releases\/.*$/
  release-agent:
    when:
      matches: { value: << pipeline.git.tag >>, pattern: "^releases/aperture-agent/.*$" }
    jobs:
      - release-components: &agent-filters
          # both this and workflow's when is needed
          filters:
            branches:
              ignore: /.+/
            tags:
              only: /^releases\/aperture-agent\/.*$/
      - package-agent:
          <<: *agent-filters
          matrix:
            parameters:
              executor: [ ubuntu-go-executor ]
              goarch: [ amd64 ]
  helm-release:
    when:
      matches: { value: << pipeline.git.tag >>, pattern: "^releases/charts/*/v*" }
    jobs:
      - helm-release:
          filters:
            tags:
              only: /^releases/charts/*/v*/
